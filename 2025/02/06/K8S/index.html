

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="集群操作环境搭建 参考: https:&#x2F;&#x2F;kubernetes.io&#x2F;zh-cn&#x2F;docs&#x2F;setup&#x2F;production-environment&#x2F;tools&#x2F;kubeadm&#x2F;create-cluster-kubeadm&#x2F; https:&#x2F;&#x2F;kubernetes.io&#x2F;zh-cn&#x2F;docs&#x2F;setup&#x2F;production-environment&#x2F;tools&#x2F;kubeadm&#x2F;install-kub">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S">
<meta property="og:url" content="http://example.com/2025/02/06/K8S/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="集群操作环境搭建 参考: https:&#x2F;&#x2F;kubernetes.io&#x2F;zh-cn&#x2F;docs&#x2F;setup&#x2F;production-environment&#x2F;tools&#x2F;kubeadm&#x2F;create-cluster-kubeadm&#x2F; https:&#x2F;&#x2F;kubernetes.io&#x2F;zh-cn&#x2F;docs&#x2F;setup&#x2F;production-environment&#x2F;tools&#x2F;kubeadm&#x2F;install-kub">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427111702557.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427112455449.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427112745566.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427113123608.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427113402217.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240506224815130.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240506224959597.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240506225228962.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240506225442460.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240521095655578.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240521095746330.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240523095912931.png">
<meta property="og:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240523100804811.png">
<meta property="article:published_time" content="2025-02-06T09:02:20.000Z">
<meta property="article:modified_time" content="2025-02-06T09:10:28.521Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ops">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/home/shanwen/Documents/Note/Pic/image-20240427111702557.png">
  
  
  
  <title>K8S - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="K8S"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-02-06 17:02" pubdate>
          2025年2月6日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          106 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">K8S</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><blockquote>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#install-and-configure-prerequisites">https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#install-and-configure-prerequisites</a></p>
<p><a target="_blank" rel="noopener" href="https://cri-o.io/">https://cri-o.io/</a></p>
</blockquote>
<p>Debian12.5+CRI-O+IPVS</p>
<p>CRI-O、Containerd、Docker、k8s的关系：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/490585683">https://zhuanlan.zhihu.com/p/490585683</a></p>
<p><code>Debian12.5默认不提供ssh root登录 修改配置文件</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@debian:~# <span class="hljs-built_in">cat</span> /etc/ssh/sshd_config | grep PermitRootLogin | grep -v <span class="hljs-string">&#x27;#&#x27;</span><br>PermitRootLogin <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure>

<h3 id="Debian系网络配置"><a href="#Debian系网络配置" class="headerlink" title="Debian系网络配置"></a>Debian系网络配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@debian:~# <span class="hljs-built_in">cat</span> /etc/network/interfaces<br><span class="hljs-built_in">source</span> /etc/network/interfaces.d/*<br><br><span class="hljs-comment"># The loopback network interface</span><br>auto lo<br>iface lo inet loopback<br><br><span class="hljs-comment"># The primary network interface</span><br>allow-hotplug enp1s0<br>auto enp1s0<br>iface enp1s0 inet static<br>address	192.168.10.50<br>netmask	255.255.255.0<br>gateway	192.168.10.1<br>dns-nameservers 8.8.8.8 8.8.4.4<br>root@debian:~# systemctl restart networking.service <br>root@debian:~# ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host noprefixroute <br>       valid_lft forever preferred_lft forever<br>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 52:54:00:16:4a:c7 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.10.50/24 brd 192.168.10.255 scope global enp1s0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::5054:ff:fe16:4ac7/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h3 id="禁用交换分区"><a href="#禁用交换分区" class="headerlink" title="禁用交换分区"></a>禁用交换分区</h3><p><code>swapoff -a</code> 然后删除 <code>/etc/fstab</code>中的swap条目即可</p>
<h3 id="配置CRI（容器运行时）"><a href="#配置CRI（容器运行时）" class="headerlink" title="配置CRI（容器运行时）"></a>配置CRI（容器运行时）</h3><h4 id="配置内核ipv4转发"><a href="#配置内核ipv4转发" class="headerlink" title="配置内核ipv4转发"></a>配置内核ipv4转发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | tee /etc/sysctl.d/k8s.conf</span><br><span class="hljs-string">net.ipv4.ip_forward = 1</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-comment"># 应用 sysctl 参数而不重新启动</span><br><span class="hljs-built_in">sudo</span> sysctl --system<br><br><span class="hljs-comment"># verify</span><br>sysctl net.ipv4.ip_forward<br></code></pre></td></tr></table></figure>

<h4 id="cgroup驱动"><a href="#cgroup驱动" class="headerlink" title="cgroup驱动"></a>cgroup驱动</h4><p>不用管 现在大部分系统都是systemd  </p>
<p>而CRI-O和kubelet默认就是systemd cgroup驱动</p>
<blockquote>
<p><strong>说明：</strong></p>
<p>从 v1.22 开始，在使用 kubeadm 创建集群时，如果用户没有在 <code>KubeletConfiguration</code> 下设置 <code>cgroupDriver</code> 字段，kubeadm 默认使用 <code>systemd</code>。</p>
</blockquote>
<blockquote>
<p>CRI-O 默认使用 systemd cgroup 驱动，这对你来说可能工作得很好。 要切换到 <code>cgroupfs</code> cgroup 驱动</p>
</blockquote>
<h4 id="安装CRI-O"><a href="#安装CRI-O" class="headerlink" title="安装CRI-O"></a>安装CRI-O</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt update<br>apt install -y software-properties-common curl<br></code></pre></td></tr></table></figure>

<h5 id="添加Kubernetes存储库"><a href="#添加Kubernetes存储库" class="headerlink" title="添加Kubernetes存储库"></a>添加Kubernetes存储库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key |<br>    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /&quot;</span> |<br>    <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list<br></code></pre></td></tr></table></figure>

<h5 id="添加CRI-O存储库"><a href="#添加CRI-O存储库" class="headerlink" title="添加CRI-O存储库"></a>添加CRI-O存储库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL https://pkgs.k8s.io/addons:/cri-o:/prerelease:/main/deb/Release.key |<br>    gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/prerelease:/main/deb/ /&quot;</span> |<br>    <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/cri-o.list<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@debian:~# <span class="hljs-built_in">ls</span> /etc/apt/keyrings/<br>cri-o-apt-keyring.gpg       kubernetes-apt-keyring.gpg <br></code></pre></td></tr></table></figure>

<h5 id="安装Kubernetes和CRI-O"><a href="#安装Kubernetes和CRI-O" class="headerlink" title="安装Kubernetes和CRI-O"></a>安装Kubernetes和CRI-O</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt update<br>apt install -y cri-o kubelet kubeadm kubectl<br></code></pre></td></tr></table></figure>

<h5 id="Pause-SandBox-配置"><a href="#Pause-SandBox-配置" class="headerlink" title="Pause SandBox 配置"></a>Pause SandBox 配置</h5><p>当我们启动一个容器时,系统会创建先Pause SandBox,然后将容器运行于Pause SandBox</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@debian:~# <span class="hljs-built_in">cat</span> /etc/crio/crio.conf<br>[crio.image]<br>pause_image=registry.k8s.io/pause:3.6<br>root@debian:~# systemctl <span class="hljs-built_in">enable</span> --now crio kubelet<br>root@debian:~# systemctl restart crio<br></code></pre></td></tr></table></figure>

<h3 id="集群初始化"><a href="#集群初始化" class="headerlink" title="集群初始化"></a>集群初始化</h3><h4 id="Master引导集群"><a href="#Master引导集群" class="headerlink" title="Master引导集群"></a>Master引导集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm init --pod-network-cidr=10.244.0.0/16<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>root@Kmaster:~# <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>root@Kmaster:~# <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br>root@Kmaster:~# <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export KUBECONFIG=/etc/kubernetes/admin.conf&#x27;</span> &gt;&gt; .bashrc ; <span class="hljs-built_in">source</span> .bashrc  <br>root@Kmaster:~# kubectl get node <br>NAME      STATUS   ROLES           AGE   VERSION<br>kmaster   Ready    control-plane   96s   v1.30.0<br>root@Kmaster:~# kubeadm token create --print-join-command<br>kubeadm <span class="hljs-built_in">join</span> 192.168.10.50:6443 --token tl09bc.a2zg1ddh01su1yv9 --discovery-token-ca-cert-hash sha256:a32510629e35260d9e4a9fb9a67f18a631897c7cb41e97daef51d29790564d17 <br></code></pre></td></tr></table></figure>

<h4 id="Worker节点加入"><a href="#Worker节点加入" class="headerlink" title="Worker节点加入"></a>Worker节点加入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Knode1:~# kubeadm <span class="hljs-built_in">join</span> 192.168.10.50:6443 --token tl09bc.a2zg1ddh01su1yv9 --discovery-token-ca-cert-hash sha256:a32510629e35260d9e4a9fb9a67f18a631897c7cb41e97daef51d29790564d17<br>root@Knode2:~# kubeadm <span class="hljs-built_in">join</span> 192.168.10.50:6443 --token tl09bc.a2zg1ddh01su1yv9 --discovery-token-ca-cert-hash sha256:a32510629e35260d9e4a9fb9a67f18a631897c7cb41e97daef51d29790564d17<br>root@Kmaster:~# kubectl get node <br>NAME      STATUS   ROLES           AGE   VERSION<br>kmaster   Ready    control-plane   15m   v1.30.0<br>knode1    Ready    &lt;none&gt;          63s   v1.30.0<br>knode2    Ready    &lt;none&gt;          7s    v1.30.0<br></code></pre></td></tr></table></figure>

<h4 id="初始化后的状态"><a href="#初始化后的状态" class="headerlink" title="初始化后的状态"></a>初始化后的状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -A <br>NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-7db6d8ff4d-2488w          1/1     Running   3          18h<br>kube-system   coredns-7db6d8ff4d-knl4n          1/1     Running   3          18h<br>kube-system   etcd-kmaster                      1/1     Running   3          18h<br>kube-system   kube-apiserver-kmaster            1/1     Running   3          18h<br>kube-system   kube-controller-manager-kmaster   1/1     Running   3          18h<br>kube-system   kube-proxy-5tkpg                  1/1     Running   2          18h<br>kube-system   kube-proxy-9tcjq                  1/1     Running   3          18h<br>kube-system   kube-proxy-bjjtl                  1/1     Running   0          19m<br>kube-system   kube-scheduler-kmaster            1/1     Running   3          18h<br></code></pre></td></tr></table></figure>

<h3 id="kubectl补全"><a href="#kubectl补全" class="headerlink" title="kubectl补全"></a>kubectl补全</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# <span class="hljs-built_in">source</span> &lt;(kubectl completion bash) <br>root@Kmaster:~# <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt; .bashrc<br></code></pre></td></tr></table></figure>

<h3 id="配置集群网络"><a href="#配置集群网络" class="headerlink" title="配置集群网络"></a>配置集群网络</h3><h4 id="IPVS模式"><a href="#IPVS模式" class="headerlink" title="IPVS模式"></a>IPVS模式</h4><h5 id="为什么是IPVS"><a href="#为什么是IPVS" class="headerlink" title="为什么是IPVS"></a>为什么是IPVS</h5><blockquote>
<p>Kube-proxy 是服务路由的构建块，它依赖于经过强化攻击的 iptables 来实现支持核心的服务类型，如 ClusterIP 和 NodePort。 但是，iptables 难以扩展到成千上万的服务，因为它纯粹是为防火墙而设计的，并且基于内核规则列表。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认使用iptables启动</span><br>root@Kmaster:~# kubectl logs -n kube-system pod/kube-proxy-5tkpg | grep iptables<br>I0514 09:56:33.869043       1 server_linux.go:69] <span class="hljs-string">&quot;Using iptables proxy&quot;</span><br>I0514 09:56:33.920683       1 server_linux.go:165] <span class="hljs-string">&quot;Using iptables Proxier&quot;</span><br>I0514 09:56:33.923842       1 proxier.go:243] <span class="hljs-string">&quot;Setting route_localnet=1 to allow node-ports on localhost; to change this either disable iptables.localhostNodePorts (--iptables-localhost-nodeports) or set nodePortAddresses (--nodeport-addresses) to filter loopback addresses&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>kube-proxy支持以下代理方式</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/networking/virtual-ips/#proxy-modes">代理模式</a></p>
<ul>
<li><code>iptables</code></li>
<li><code>IPVS</code></li>
<li><code>nftables</code>           #unstable v1.30</li>
<li><code>kernelspace</code>     #windows</li>
</ul>
</blockquote>
<h5 id="节点安装-ipvsadm"><a href="#节点安装-ipvsadm" class="headerlink" title="节点安装 ipvsadm"></a>节点安装 ipvsadm</h5><p>ansible.yaml file</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">k8s</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apt:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">ipvsadm</span><br>      <span class="hljs-attr">state:</span> <span class="hljs-string">latest</span><br></code></pre></td></tr></table></figure>

<h5 id="内核模块"><a href="#内核模块" class="headerlink" title="内核模块"></a>内核模块</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /etc/modules-load.d/ipvs.modules &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">#!/bin/bash</span><br><span class="hljs-string">modprobe -- br_netfilter</span><br><span class="hljs-string">modprobe -- ip_vs</span><br><span class="hljs-string">modprobe -- ip_vs_rr</span><br><span class="hljs-string">modprobe -- ip_vs_wrr</span><br><span class="hljs-string">modprobe -- ip_vs_sh</span><br><span class="hljs-string">modprobe -- nf_conntrack</span><br><span class="hljs-string">EOF</span><br> <br><span class="hljs-built_in">chmod</span>  755  /etc/modules-load.d/ipvs.modules &amp;&amp; bash /etc/modules-load.d/ipvs.modules<br><br>root@Kmaster:~# lsmod | grep -e ip_vs -e nf_conntrack_ipv4<br>ip_vs_sh               16384  0<br>ip_vs_wrr              16384  0<br>ip_vs_rr               16384  0<br>ip_vs                 188416  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr<br>nf_conntrack          188416  6 xt_conntrack,nf_nat,xt_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs<br>nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs<br>libcrc32c              16384  4 nf_conntrack,nf_nat,nf_tables,ip_vs<br></code></pre></td></tr></table></figure>

<h5 id="修改kube-proxy"><a href="#修改kube-proxy" class="headerlink" title="修改kube-proxy"></a>修改kube-proxy</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl edit -n kube-system configmaps kube-proxy<br><span class="hljs-comment"># 更改为 mode: &quot;ipvs&quot;</span><br>configmap/kube-proxy edited<br></code></pre></td></tr></table></figure>

<h5 id="删除原有kube-peoxy"><a href="#删除原有kube-peoxy" class="headerlink" title="删除原有kube-peoxy"></a>删除原有kube-peoxy</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -A<br>NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-7db6d8ff4d-2488w          1/1     Running   3          22h<br>kube-system   coredns-7db6d8ff4d-knl4n          1/1     Running   3          22h<br>kube-system   etcd-kmaster                      1/1     Running   3          22h<br>kube-system   kube-apiserver-kmaster            1/1     Running   3          22h<br>kube-system   kube-controller-manager-kmaster   1/1     Running   3          22h<br>kube-system   kube-proxy-5tkpg                  1/1     Running   2          22h<br>kube-system   kube-proxy-9tcjq                  1/1     Running   3          22h<br>kube-system   kube-proxy-bjjtl                  1/1     Running   0          4h44m<br>kube-system   kube-scheduler-kmaster            1/1     Running   3          22h<br>root@Kmaster:~# kubectl delete -n kube-system pod/&#123;kube-proxy-5tkpg,kube-proxy-9tcjq,kube-proxy-bjjtl&#125;<br>pod <span class="hljs-string">&quot;kube-proxy-5tkpg&quot;</span> deleted<br>pod <span class="hljs-string">&quot;kube-proxy-9tcjq&quot;</span> deleted<br>pod <span class="hljs-string">&quot;kube-proxy-bjjtl&quot;</span> deleted<br></code></pre></td></tr></table></figure>

<h5 id="Verify"><a href="#Verify" class="headerlink" title="Verify"></a>Verify</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -A <br>NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-7db6d8ff4d-2488w          1/1     Running   3          22h<br>kube-system   coredns-7db6d8ff4d-knl4n          1/1     Running   3          22h<br>kube-system   etcd-kmaster                      1/1     Running   3          22h<br>kube-system   kube-apiserver-kmaster            1/1     Running   3          22h<br>kube-system   kube-controller-manager-kmaster   1/1     Running   3          22h<br>kube-system   kube-proxy-fxb2p                  1/1     Running   0          45s<br>kube-system   kube-proxy-g8vr9                  1/1     Running   0          45s<br>kube-system   kube-proxy-xtrcm                  1/1     Running   0          45s<br>kube-system   kube-scheduler-kmaster            1/1     Running   3          22h<br>root@Kmaster:~# kubectl logs -n kube-system pods/kube-proxy-fxb2p | grep ipvs <br>I0514 14:44:49.218298       1 server_linux.go:233] <span class="hljs-string">&quot;Using ipvs Proxier&quot;</span><br>root@Kmaster:~# <br></code></pre></td></tr></table></figure>

<h4 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h4><p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml<br>namespace/tigera-operator created<br>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/bgpfilters.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created<br>customresourcedefinition.apiextensions.k8s.io/apiservers.operator.tigera.io created<br>customresourcedefinition.apiextensions.k8s.io/imagesets.operator.tigera.io created<br>customresourcedefinition.apiextensions.k8s.io/installations.operator.tigera.io created<br>customresourcedefinition.apiextensions.k8s.io/tigerastatuses.operator.tigera.io created<br>serviceaccount/tigera-operator created<br>clusterrole.rbac.authorization.k8s.io/tigera-operator created<br>clusterrolebinding.rbac.authorization.k8s.io/tigera-operator created<br>deployment.apps/tigera-operator created<br></code></pre></td></tr></table></figure>

<h5 id="等待Tigera-NS的pod启动完成"><a href="#等待Tigera-NS的pod启动完成" class="headerlink" title="等待Tigera NS的pod启动完成"></a>等待Tigera NS的pod启动完成</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -n tigera-operator <br>NAME                               READY   STATUS    RESTARTS   AGE<br>tigera-operator-76ff79f7fd-29mh2   1/1     Running   0          2m38s<br></code></pre></td></tr></table></figure>

<h5 id="下载自定义文件"><a href="#下载自定义文件" class="headerlink" title="下载自定义文件"></a>下载自定义文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">root@Kmaster:~#</span> <span class="hljs-string">wget</span> <span class="hljs-string">https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml</span><br><span class="hljs-string">root@Kmaster:~#</span> <span class="hljs-string">vim</span> <span class="hljs-string">custom-resources.yaml</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">operator.tigera.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Installation</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-comment"># Configures Calico networking.</span><br>  <span class="hljs-attr">calicoNetwork:</span><br>    <span class="hljs-attr">ipPools:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">default-ipv4-ippool</span><br>      <span class="hljs-attr">blockSize:</span> <span class="hljs-number">26</span><br>      <span class="hljs-attr">cidr:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span>  <span class="hljs-comment">##修改为自己的pod 集群引导时指定过</span><br>      <span class="hljs-attr">encapsulation:</span> <span class="hljs-string">VXLANCrossSubnet</span><br>      <span class="hljs-attr">natOutgoing:</span> <span class="hljs-string">Enabled</span><br>      <span class="hljs-attr">nodeSelector:</span> <span class="hljs-string">all()</span><br><span class="hljs-string">root@Kmaster:~#</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">custom-resources.yaml</span><br><span class="hljs-string">installation.operator.tigera.io/default</span> <span class="hljs-string">created</span><br><span class="hljs-string">apiserver.operator.tigera.io/default</span> <span class="hljs-string">created</span><br></code></pre></td></tr></table></figure>

<h5 id="Verify-1"><a href="#Verify-1" class="headerlink" title="Verify"></a>Verify</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -A<br>NAMESPACE          NAME                                      READY   STATUS    RESTARTS        AGE<br>calico-apiserver   calico-apiserver-666c4c5b4f-tldvz         1/1     Running   0               89s<br>calico-apiserver   calico-apiserver-666c4c5b4f-zl7t7         1/1     Running   0               89s<br>calico-system      calico-kube-controllers-f6cf9c5d5-qtct6   1/1     Running   0               4m29s<br>calico-system      calico-node-98h7p                         1/1     Running   0               4m31s<br>calico-system      calico-node-kn2fz                         1/1     Running   0               4m31s<br>calico-system      calico-node-wjwt4                         1/1     Running   0               4m31s<br>calico-system      calico-typha-76dd7b65-d4sft               1/1     Running   0               4m32s<br>calico-system      calico-typha-76dd7b65-qsjd9               1/1     Running   0               4m26s<br>calico-system      csi-node-driver-6fpwf                     2/2     Running   0               4m30s<br>calico-system      csi-node-driver-869h6                     2/2     Running   0               4m30s<br>calico-system      csi-node-driver-lrltb                     2/2     Running   0               4m30s<br>kube-system        coredns-7db6d8ff4d-2488w                  1/1     Running   3               23h<br>kube-system        coredns-7db6d8ff4d-knl4n                  1/1     Running   3               23h<br>kube-system        etcd-kmaster                              1/1     Running   3               23h<br>kube-system        kube-apiserver-kmaster                    1/1     Running   3               23h<br>kube-system        kube-controller-manager-kmaster           1/1     Running   4 (3m12s ago)   23h<br>kube-system        kube-proxy-fxb2p                          1/1     Running   0               16m<br>kube-system        kube-proxy-g8vr9                          1/1     Running   0               16m<br>kube-system        kube-proxy-xtrcm                          1/1     Running   0               16m<br>kube-system        kube-scheduler-kmaster                    1/1     Running   4 (3m12s ago)   23h<br>tigera-operator    tigera-operator-76ff79f7fd-29mh2          1/1     Running   1 (3m18s ago)   11m<br></code></pre></td></tr></table></figure>

<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a><strong>Metrics</strong></h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/">HorizontalPodAutoscaler</a> (HPA) 和 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler#readme">VerticalPodAutoscaler</a> (VPA) 使用 metrics API 中的数据调整工作负载副本和资源，以满足客户需求。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml<br>serviceaccount/metrics-server created<br>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created<br>clusterrole.rbac.authorization.k8s.io/system:metrics-server created<br>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created<br>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created<br>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created<br>service/metrics-server created<br>deployment.apps/metrics-server created<br>poddisruptionbudget.policy/metrics-server created<br>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created<br><br>root@Kmaster:~# kubectl get pod -n kube-system <br>NAME                              READY   STATUS    RESTARTS      AGE<br>coredns-7db6d8ff4d-2488w          1/1     Running   3             23h<br>coredns-7db6d8ff4d-knl4n          1/1     Running   3             23h<br>etcd-kmaster                      1/1     Running   3             23h<br>kube-apiserver-kmaster            1/1     Running   3             23h<br>kube-controller-manager-kmaster   1/1     Running   4 (14m ago)   23h<br>kube-proxy-fxb2p                  1/1     Running   0             28m<br>kube-proxy-g8vr9                  1/1     Running   0             28m<br>kube-proxy-xtrcm                  1/1     Running   0             28m<br>kube-scheduler-kmaster            1/1     Running   4 (14m ago)   23h<br>metrics-server-fdc58cbc8-xrtqh    0/1     Running   0             3m22s<br>metrics-server-fdc58cbc8-znq7v    0/1     Running   0             3m22s<br><br><span class="hljs-comment">## 未运行？？</span><br>root@Kmaster:~# kubectl edit -n kube-system deployments.apps metrics-server<br>      containers:<br>      - args:<br>        - --kubelet-insecure-tls                 <span class="hljs-comment">## ad</span><br>        - --cert-dir=/tmp<br>        - --secure-port=10250<br>        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname<br>        - --kubelet-use-node-status-port<br>        - --metric-resolution=15s<br>        image: registry.k8s.io/metrics-server/metrics-server:v0.7.1<br>deployment.apps/metrics-server edited<br><br>root@Kmaster:~# kubectl get pod -A <br>NAMESPACE          NAME                                      READY   STATUS    RESTARTS      AGE<br>calico-apiserver   calico-apiserver-666c4c5b4f-tldvz         1/1     Running   0             17m<br>calico-apiserver   calico-apiserver-666c4c5b4f-zl7t7         1/1     Running   0             17m<br>calico-system      calico-kube-controllers-f6cf9c5d5-qtct6   1/1     Running   0             20m<br>calico-system      calico-node-98h7p                         1/1     Running   0             20m<br>calico-system      calico-node-kn2fz                         1/1     Running   0             20m<br>calico-system      calico-node-wjwt4                         1/1     Running   0             20m<br>calico-system      calico-typha-76dd7b65-d4sft               1/1     Running   0             20m<br>calico-system      calico-typha-76dd7b65-qsjd9               1/1     Running   0             20m<br>calico-system      csi-node-driver-6fpwf                     2/2     Running   0             20m<br>calico-system      csi-node-driver-869h6                     2/2     Running   0             20m<br>calico-system      csi-node-driver-lrltb                     2/2     Running   0             20m<br>kube-system        coredns-7db6d8ff4d-2488w                  1/1     Running   3             23h<br>kube-system        coredns-7db6d8ff4d-knl4n                  1/1     Running   3             23h<br>kube-system        etcd-kmaster                              1/1     Running   3             23h<br>kube-system        kube-apiserver-kmaster                    1/1     Running   3             23h<br>kube-system        kube-controller-manager-kmaster           1/1     Running   4 (19m ago)   23h<br>kube-system        kube-proxy-fxb2p                          1/1     Running   0             32m<br>kube-system        kube-proxy-g8vr9                          1/1     Running   0             32m<br>kube-system        kube-proxy-xtrcm                          1/1     Running   0             32m<br>kube-system        kube-scheduler-kmaster                    1/1     Running   4 (19m ago)   23h<br>kube-system        metrics-server-5b68c8cbcc-dc5cs           1/1     Running   0             76s<br>kube-system        metrics-server-5b68c8cbcc-ts7fl           1/1     Running   0             76s<br>tigera-operator    tigera-operator-76ff79f7fd-29mh2          1/1     Running   1 (19m ago)   27m<br></code></pre></td></tr></table></figure>

<h4 id="Verify-2"><a href="#Verify-2" class="headerlink" title="Verify"></a>Verify</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl top node <br>NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   <br>kmaster   229m         11%    1138Mi          153%      <br>knode1    79m          3%     471Mi           63%       <br>knode2    68m          3%     489Mi           65% <br></code></pre></td></tr></table></figure>

<h3 id="搭建完成"><a href="#搭建完成" class="headerlink" title="搭建完成"></a>搭建完成</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl create deployment n1 --image  nginx --replicas 3 <br>deployment.apps/n1 created<br>root@Kmaster:~# kubectl expose deployment n1 --port 80 --target-port 80 --<span class="hljs-built_in">type</span> NodePort <br>service/n1 exposed<br>root@Kmaster:~# kubectl get deployments.apps,svc<br>NAME                 READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/n1   3/3     3            3           71s<br><br>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE<br>service/kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        23h<br>service/n1           NodePort    10.104.126.111   &lt;none&gt;        80:31897/TCP   46s<br><br>shanwen@Arch:/home/shanwen$ curl Kmaster:31897<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;<br>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br>&lt;style&gt;<br>html &#123; color-scheme: light dark; &#125;<br>body &#123; width: 35em; margin: 0 auto;<br>font-family: Tahoma, Verdana, Arial, sans-serif; &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>root@Kmaster:~# kubectl delete deployments.apps/n1 svc/n1<br>deployment.apps <span class="hljs-string">&quot;n1&quot;</span> deleted<br>service <span class="hljs-string">&quot;n1&quot;</span> deleted<br>root@Kmaster:~# kubectl get pod -A <br>NAMESPACE          NAME                                      READY   STATUS    RESTARTS      AGE<br>calico-apiserver   calico-apiserver-666c4c5b4f-tldvz         1/1     Running   0             22m<br>calico-apiserver   calico-apiserver-666c4c5b4f-zl7t7         1/1     Running   0             22m<br>calico-system      calico-kube-controllers-f6cf9c5d5-qtct6   1/1     Running   0             25m<br>calico-system      calico-node-98h7p                         1/1     Running   0             25m<br>calico-system      calico-node-kn2fz                         1/1     Running   0             25m<br>calico-system      calico-node-wjwt4                         1/1     Running   0             25m<br>calico-system      calico-typha-76dd7b65-d4sft               1/1     Running   0             25m<br>calico-system      calico-typha-76dd7b65-qsjd9               1/1     Running   0             25m<br>calico-system      csi-node-driver-6fpwf                     2/2     Running   0             25m<br>calico-system      csi-node-driver-869h6                     2/2     Running   0             25m<br>calico-system      csi-node-driver-lrltb                     2/2     Running   0             25m<br>kube-system        coredns-7db6d8ff4d-2488w                  1/1     Running   3             23h<br>kube-system        coredns-7db6d8ff4d-knl4n                  1/1     Running   3             23h<br>kube-system        etcd-kmaster                              1/1     Running   3             23h<br>kube-system        kube-apiserver-kmaster                    1/1     Running   3             23h<br>kube-system        kube-controller-manager-kmaster           1/1     Running   4 (23m ago)   23h<br>kube-system        kube-proxy-fxb2p                          1/1     Running   0             37m<br>kube-system        kube-proxy-g8vr9                          1/1     Running   0             37m<br>kube-system        kube-proxy-xtrcm                          1/1     Running   0             37m<br>kube-system        kube-scheduler-kmaster                    1/1     Running   4 (23m ago)   23h<br>kube-system        metrics-server-5b68c8cbcc-dc5cs           1/1     Running   0             5m52s<br>kube-system        metrics-server-5b68c8cbcc-ts7fl           1/1     Running   0             5m52s<br>tigera-operator    tigera-operator-76ff79f7fd-29mh2          1/1     Running   1 (23m ago)   32m<br>root@Kmaster:~# <br></code></pre></td></tr></table></figure>

<h2 id="新环境搭建"><a href="#新环境搭建" class="headerlink" title="新环境搭建"></a>新环境搭建</h2><p>openEuler24.03LTS+CRI-O+Cilium+IPVS</p>
<h2 id="升级集群"><a href="#升级集群" class="headerlink" title="升级集群"></a>升级集群</h2><p>参考官网教程</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></p>
</blockquote>
<h3 id="查看可升级的版本"><a href="#查看可升级的版本" class="headerlink" title="查看可升级的版本"></a>查看可升级的版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dnf list --showduplicates kubeadm --disableexcludes=kubernetes<br></code></pre></td></tr></table></figure>

<p><code>先配置对应的仓库源</code></p>
<h3 id="安装对应版本的kubeadm"><a href="#安装对应版本的kubeadm" class="headerlink" title="安装对应版本的kubeadm"></a>安装对应版本的kubeadm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dnf install -y kubeadm-&#x27;1.29.150500.2.1&#x27; --disableexcludes=kubernetes<br></code></pre></td></tr></table></figure>

<h3 id="验证升级计划"><a href="#验证升级计划" class="headerlink" title="验证升级计划"></a>验证升级计划</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm upgrade plan<br></code></pre></td></tr></table></figure>

<p><img src="/home/shanwen/Documents/Note/Pic/image-20240427111702557.png" srcset="/img/loading.gif" lazyload alt="image-20240427111702557"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm upgrade apply v1.29.4<br></code></pre></td></tr></table></figure>

<p><img src="/home/shanwen/Documents/Note/Pic/image-20240427112455449.png" srcset="/img/loading.gif" lazyload alt="image-20240427112455449"></p>
<h3 id="接着升级kubelet"><a href="#接着升级kubelet" class="headerlink" title="接着升级kubelet"></a>接着升级kubelet</h3><h4 id="驱逐节点的pod"><a href="#驱逐节点的pod" class="headerlink" title="驱逐节点的pod"></a>驱逐节点的pod</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets<br></code></pre></td></tr></table></figure>

<p><code>驱逐Master节点上的pod</code></p>
<p><img src="/home/shanwen/Documents/Note/Pic/image-20240427112745566.png" srcset="/img/loading.gif" lazyload alt="image-20240427112745566"></p>
<h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dnf list --showduplicates kubelet --disableexcludes=kubernetes<br></code></pre></td></tr></table></figure>

<p><img src="/home/shanwen/Documents/Note/Pic/image-20240427113123608.png" srcset="/img/loading.gif" lazyload alt="image-20240427113123608"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dnf install -y kubelet-&#x27;1.29.4&#x27; kubectl-&#x27;1.29.4&#x27; --disableexcludes=kubernetes<br></code></pre></td></tr></table></figure>

<h4 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br>sudo systemctl restart kubelet<br></code></pre></td></tr></table></figure>

<h4 id="取消对节点的驱逐"><a href="#取消对节点的驱逐" class="headerlink" title="取消对节点的驱逐"></a>取消对节点的驱逐</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">shanwen@Arch:~$ kubectl uncordon kmaster <br>node/kmaster uncordoned<br></code></pre></td></tr></table></figure>

<h4 id="控制平面升级完成"><a href="#控制平面升级完成" class="headerlink" title="控制平面升级完成"></a>控制平面升级完成</h4><p><img src="/home/shanwen/Documents/Note/Pic/image-20240427113402217.png" srcset="/img/loading.gif" lazyload alt="image-20240427113402217"></p>
<h3 id="计算节点升级"><a href="#计算节点升级" class="headerlink" title="计算节点升级"></a>计算节点升级</h3><p>前面安装软件对应的软件包 然后<code>kubeadm upgrade node</code></p>
<h4 id="排空节点"><a href="#排空节点" class="headerlink" title="排空节点"></a>排空节点</h4><p><img src="/home/shanwen/Documents/Note/Pic/image-20240506224815130.png" srcset="/img/loading.gif" lazyload alt="image-20240506224815130"></p>
<h4 id="升级后重启kubelet-kubectl"><a href="#升级后重启kubelet-kubectl" class="headerlink" title="升级后重启kubelet kubectl"></a>升级后重启kubelet kubectl</h4><p><img src="/home/shanwen/Documents/Note/Pic/image-20240506224959597.png" srcset="/img/loading.gif" lazyload alt="image-20240506224959597"></p>
<h4 id="解除节点的不可调度状态"><a href="#解除节点的不可调度状态" class="headerlink" title="解除节点的不可调度状态"></a>解除节点的不可调度状态</h4><p><img src="/home/shanwen/Documents/Note/Pic/image-20240506225228962.png" srcset="/img/loading.gif" lazyload alt="image-20240506225228962"></p>
<h4 id="verify"><a href="#verify" class="headerlink" title="verify"></a>verify</h4><p><img src="/home/shanwen/Documents/Note/Pic/image-20240506225442460.png" srcset="/img/loading.gif" lazyload alt="image-20240506225442460"></p>
<h1 id="AppArmor"><a href="#AppArmor" class="headerlink" title="AppArmor"></a>AppArmor</h1><blockquote>
<p><strong>容器在运行时对宿主资源访问限制</strong></p>
</blockquote>
<p>kubernetes官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tutorials/security/apparmor/">https://kubernetes.io/zh-cn/docs/tutorials/security/apparmor/</a></p>
<h2 id="什么是AppAemor"><a href="#什么是AppAemor" class="headerlink" title="什么是AppAemor"></a>什么是AppAemor</h2><p>简单来说就是Debian系的SElinux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs APL"># /etc/apparmor.d/usr.bin.firefox<br>#include &lt;tunables/global&gt;<br><br>profile /usr/bin/firefox &#123;<br>  # 允许读取全局配置文件<br>  #include &lt;abstractions/base&gt;<br>  #include &lt;abstractions/browser-plugin&gt;<br><br>  # 限制 Firefox 访问的文件和目录<br>  /usr/bin/firefox mr,<br>  /etc/firefox/** r,<br>  /usr/lib/firefox/** rm,<br>  /usr/share/firefox/** r,<br>  /tmp/** rwk,<br><br>  # 限制网络访问<br>  network inet stream,<br>  network inet dgram,<br><br>  # 限制对系统资源的访问<br>  capability net_bind_service,<br><br>  # 允许访问用户配置和缓存文件<br>  owner @&#123;HOME&#125;/.mozilla/firefox/** rwk,<br>  owner @&#123;HOME&#125;/.cache/mozilla/firefox/** rwk,<br><br>  # 读写用户下载目录<br>  owner @&#123;HOME&#125;/Downloads/** rwk,<br><br>  # 忽略一些无害的拒绝消息<br>  deny /var/log/** w,<br>  deny @&#123;HOME&#125;/.ssh/** rw,<br><br>  # 添加其他自定义限制<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong><code>#include &lt;tunables/global&gt;</code></strong>: 包含全局变量定义。</li>
<li><strong><code>profile /usr/bin/firefox &#123; ... &#125;</code></strong>: 定义 <code>/usr/bin/firefox</code> 的 AppArmor 配置文件。</li>
<li>权限修饰符<ul>
<li><strong><code>r</code></strong>: 读取权限（read）。</li>
<li><strong><code>w</code></strong>: 写入权限（write）。</li>
<li><strong><code>k</code></strong>: 锁定权限（lock）。</li>
<li><strong><code>m</code></strong>: 映射权限（map）。</li>
<li><strong><code>rwk</code></strong>: 读写锁定权限。</li>
<li><strong><code>rm</code></strong>: 读取和映射权限。</li>
<li><strong><code>rw</code></strong>: 读写权限。</li>
</ul>
</li>
<li><strong><code>network inet stream</code> 和 <code>network inet dgram</code></strong>: 允许访问网络（流和数据报）。</li>
<li><strong><code>capability</code></strong>: 定义允许的系统能力（如 <code>sys_admin</code>, <code>net_bind_service</code>）。</li>
<li><strong><code>owner</code></strong>: 表示只有文件的所有者才能执行指定操作。</li>
</ul>
<p>用于容器就是限制容器对资源的访问 在创建容器是需要指定对应的策略名</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">hello-apparmor</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-comment"># 告知 Kubernetes 去应用 AppArmor 配置 &quot;k8s-apparmor-example-deny-write&quot;。</span><br>    <span class="hljs-comment"># 请注意，如果节点上运行的 Kubernetes 不是 1.4 或更高版本，此注解将被忽略。</span><br>    <span class="hljs-attr">container.apparmor.security.beta.kubernetes.io/hello:</span> <span class="hljs-string">localhost/k8s-apparmor-example-deny-write</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28</span><br>    <span class="hljs-attr">command:</span> [ <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo &#x27;Hello AppArmor!&#x27; &amp;&amp; sleep 1h&quot;</span> ]<br></code></pre></td></tr></table></figure>

<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">apparmor_parser /etc/apparmor.d/usr.bin.firefox    <span class="hljs-comment">##加载一个新的配置文件</span><br>apparmor_parser -r /etc/apparmor.d/usr.bin.firefox <span class="hljs-comment">##替换一个配置文件</span><br>apparmor_parser -R /etc/apparmor.d/usr.bin.firefox <span class="hljs-comment">##卸载一个配置文件</span><br>apparmor_status									   <span class="hljs-comment">##查看当前apparmor状态</span><br></code></pre></td></tr></table></figure>

<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><h3 id="正确操作"><a href="#正确操作" class="headerlink" title="正确操作"></a>正确操作</h3><p>在 cluster 的工作节点上，实施位于 的现有 AppArmor 配置文件。<br>编辑位于 的现有清单文件以应用 AppArmor 配置文件。<br>最后，应用清单文件并创建其中指定的 Pod 。<code>/etc/apparmor.d/nginx_apparmor</code> <code>/home/candidate/KSSH00401/nginx-deploy.yaml</code></p>
<blockquote>
<p>由于我不知道考题的文件 只能自己杜撰了 </p>
<p>这个配置文件需要在运行这个pod的主机上 执行加载动作</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs APL">root@Knode1:~# cat /etc/apparmor.d/nginx-container.profile<br>#include &lt;tunables/global&gt;<br><br>profile nginxContainer flags=(attach_disconnected) &#123;<br>  #include &lt;abstractions/base&gt;<br><br>  file,<br><br>  deny /** w,<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Knode1:~# apparmor_parser /etc/apparmor.d/nginx-container.profile <br>root@Knode1:~# apparmor_status | grep nginx<br>   nginxContainer<br>root@Knode1:~# <span class="hljs-built_in">cat</span> /sys/kernel/security/apparmor/profiles<br>nginxContainer (enforce)<br>k8s-apparmor-example-deny-write (enforce)<br>crio-default (enforce)<br>/&#123;,usr/&#125;sbin/dhclient (enforce)<br>/usr/lib/connman/scripts/dhclient-script (enforce)<br>/usr/lib/NetworkManager/nm-dhcp-helper (enforce)<br>/usr/lib/NetworkManager/nm-dhcp-client.action (enforce)<br>man_groff (enforce)<br>man_filter (enforce)<br>/usr/bin/man (enforce)<br>lsb_release (enforce)<br>nvidia_modprobe (enforce)<br>nvidia_modprobe//kmod (enforce)<br></code></pre></td></tr></table></figure>

<p>由于我只在Knode1上执行了apparmor配置文件的加载 带有apparmor注解的pod只能在这上面加载 否则会pendding </p>
<p>确保最后一条命令能看见你写的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl run nginx --image nginx --image-pull-policy IfNotPresent --dry-run=client --output yaml &gt; nginxContainers.yaml<br></code></pre></td></tr></table></figure>

<p><code>我这个是V1.30版本的 考试如果是其他版本 需要按照官网教程 </code></p>
<p><code> appArmorProfile/nginx: localhost/nginxContainer</code>  :</p>
<ul>
<li>nginx需要换成你pod的名称 </li>
<li>nginxContainer就是apparmor配置中指定的名称 不是文件名称</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># cat nginxContainers.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">securityContext:</span><br>    <span class="hljs-attr">appArmorProfile:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">Localhost</span><br>      <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">nginxContainer</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">resources:</span> &#123;&#125;<br>  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br><span class="hljs-attr">status:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>发现pod启动失败</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl get pod/nginx <br>NAME    READY   STATUS   RESTARTS      AGE<br>nginx   0/1     Error    5 (96s ago)   3m8s<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl get pod/nginx -o wide <br>NAME    READY   STATUS             RESTARTS      AGE     IP               NODE     NOMINATED NODE   READINESS GATES<br>nginx   0/1     CrashLoopBackOff   5 (17s ago)   3m14s   10.244.195.152   knode1   &lt;none&gt;           &lt;none&gt;<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl logs pod/nginx<br>/docker-entrypoint.sh: 13: cannot create /dev/null: Permission denied<br>/docker-entrypoint.sh: No files found <span class="hljs-keyword">in</span> /docker-entrypoint.d/, skipping configuration<br>2024/05/19 04:35:20 [emerg] 1#1: <span class="hljs-built_in">mkdir</span>() <span class="hljs-string">&quot;/var/cache/nginx/client_temp&quot;</span> failed (13: Permission denied)<br>nginx: [emerg] <span class="hljs-built_in">mkdir</span>() <span class="hljs-string">&quot;/var/cache/nginx/client_temp&quot;</span> failed (13: Permission denied)<br></code></pre></td></tr></table></figure>

<p>因为我们apparmor文件就是拒绝所有文件写入 看起来是配置生效了 </p>
<p>所以容器创建必要文件没有权限 然后启动失败</p>
<p>那就改一个镜像</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># cat nginxContainers.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">securityContext:</span><br>    <span class="hljs-attr">appArmorProfile:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">Localhost</span><br>      <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">nginxContainer</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">alpine</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">command:</span> [ <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo &#x27;Hello AppArmor!&#x27; &amp;&amp; sleep 1h&quot;</span> ]<br>    <span class="hljs-attr">resources:</span> &#123;&#125;<br>  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br><span class="hljs-attr">status:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl get pod<br>NAME    READY   STATUS    RESTARTS   AGE<br>nginx   1/1     Running   0          109s<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl <span class="hljs-built_in">exec</span> pod/nginx -- <span class="hljs-built_in">cat</span> /proc/1/attr/current<br>nginxContainer (enforce)<br></code></pre></td></tr></table></figure>

<h3 id="错误创建"><a href="#错误创建" class="headerlink" title="错误创建"></a>错误创建</h3><p>那我们把他调度到没有该AppArmor的Knode2上 会启动吗</p>
<p>参考： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl label nodes knode2 node=node02<br>node/knode2 labeled<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl get nodes --show-labels <br>NAME      STATUS   ROLES           AGE     VERSION   LABELS<br>kmaster   Ready    control-plane   5d13h   v1.30.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=kmaster,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=<br>knode1    Ready    &lt;none&gt;          5d12h   v1.30.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=knode1,kubernetes.io/os=linux<br>knode2    Ready    &lt;none&gt;          5d12h   v1.30.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=knode2,kubernetes.io/os=linux,node=node02<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ <span class="hljs-built_in">cat</span> nginxContainers.yaml<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  creationTimestamp: null<br>  labels:<br>    run: nginx<br>  name: nginx<br>spec:<br>  securityContext:<br>    appArmorProfile:<br>      <span class="hljs-built_in">type</span>: Localhost<br>      localhostProfile: nginxContainer<br>  containers:<br>  - image: alpine<br>    imagePullPolicy: IfNotPresent<br>    name: nginx<br>    <span class="hljs-built_in">command</span>: [ <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo &#x27;Hello AppArmor!&#x27; &amp;&amp; sleep 1h&quot;</span> ]<br>    resources: &#123;&#125;<br>  nodeSelector:<br>    node: node02<br>  dnsPolicy: ClusterFirst<br>  restartPolicy: Always<br>status: &#123;&#125;<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl apply -f nginxContainers.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl get pod<br>NAME    READY   STATUS                 RESTARTS   AGE<br>nginx   0/1     CreateContainerError   0          25s<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/yaml$ kubectl describe pod/nginx | grep -i error<br>      Reason:       CreateContainerError<br>  Warning  Failed     10s (x11 over 2m11s)  kubelet            Error: container create failed: write file `/proc/thread-self/attr/apparmor/exec`: No such file or directory<br></code></pre></td></tr></table></figure>

<p>创建错误 Knode2上找不到所需的AppArmor配置文件</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ul>
<li>在需要创建的Node上编辑AppArmor文件</li>
<li>加载AppArmor配置文件 并确保能看见 <code>apparmor_parser /etc/apparmor.d/usr.bin.firefox</code> <code>cat /sys/kernel/security/apparmor/profiles</code></li>
<li>编辑pod Yaml文件 添加注解</li>
<li>apply -f 运行</li>
</ul>
<h1 id="kube-bench"><a href="#kube-bench" class="headerlink" title="kube-bench"></a>kube-bench</h1><blockquote>
<p><strong>K8S集群安全扫描、保障</strong></p>
</blockquote>
<h2 id="什么是Kube-bench"><a href="#什么是Kube-bench" class="headerlink" title="什么是Kube-bench"></a>什么是Kube-bench</h2><p>作为一个基于开源 Go 开发的应用程序，Kube-bench 主要用于检查 Kubernetes Cluster 是否根据安全最佳实践进行部署规划。它实现了 CIS Kubernetes 基准，这些基准是由互联网安全中心开发的用于以安全方式运行 Kubernetes 的指导性文档。Kube-bench 可以针对自我管理的 Kubernetes Cluster 以及由流行的云提供商（如 AWS、Azure、GKE Cluster 等）管理的 Kubernetes Cluster 执行。<code>也就是对K8S集群层面的安全保障</code></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>参考：<a target="_blank" rel="noopener" href="https://aquasecurity.github.io/kube-bench/v0.6.15/installation/">https://aquasecurity.github.io/kube-bench/v0.6.15/installation/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kube-bench# curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.6.2/kube-bench_0.6.2_linux_amd64.tar.gz -o kube-bench_0.6.2_linux_amd64.tar.gz<br>root@Kmaster:~# tar xzvf kube-bench_0.6.2_linux_amd64.tar.gz<br>root@Kmaster:~/kube-bench# <span class="hljs-built_in">chmod</span> a+x kube-bench; <span class="hljs-built_in">mv</span> kube-bench /usr/bin/<br></code></pre></td></tr></table></figure>

<p>如果您手动下载了 kube-bench 二进制文件（使用上面的 curl 命令），则必须指定配置目录和文件的位置。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kube-bench --config-dir `<span class="hljs-built_in">pwd</span>`/cfg --config `<span class="hljs-built_in">pwd</span>`/cfg/config.yaml <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kube-bench --config-dir `<span class="hljs-built_in">pwd</span>`/cfg --config `<span class="hljs-built_in">pwd</span>`/cfg/config.yaml run --targets master<br>[INFO] 1 Master Node Security Configuration<br>[INFO] 1.1 Master Node Configuration Files<br>[PASS] 1.1.1 Ensure that the API server pod specification file permissions are <span class="hljs-built_in">set</span> to 644 or more restrictive (Automated)<br>[PASS] 1.1.2 Ensure that the API server pod specification file ownership is <span class="hljs-built_in">set</span> to root:root (Automated)<br>[PASS] 1.1.3 Ensure that the controller manager pod specification file permissions are <span class="hljs-built_in">set</span> to 644 or more restrictive (Automated)<br>[PASS] 1.1.4 Ensure that the controller manager pod specification file ownership is <span class="hljs-built_in">set</span> to root:root (Automated)<br>[PASS] 1.1.5 Ensure that the scheduler pod specification file permissions are <span class="hljs-built_in">set</span> to 644 or more restrictive (Automated)<br><br>..........................................................<br><br>1.3.2 Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml<br>on the master node and <span class="hljs-built_in">set</span> the below parameter.<br>--profiling=<span class="hljs-literal">false</span><br><br>1.4.1 Edit the Scheduler pod specification file /etc/kubernetes/manifests/kube-scheduler.yaml file<br>on the master node and <span class="hljs-built_in">set</span> the below parameter.<br>--profiling=<span class="hljs-literal">false</span><br><br><br>== Summary master ==<br>43 checks PASS<br>11 checks FAIL<br>11 checks WARN<br>0 checks INFO<br><br>== Summary total ==<br>43 checks PASS<br>11 checks FAIL<br>11 checks WARN<br>0 checks INFO<br><br></code></pre></td></tr></table></figure>

<h2 id="Task-1"><a href="#Task-1" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>Fix all issues via configuration and restart theaffected components to ensure the new settings take effect.<br>通过配置修复所有问题并重新启动受影响的组件以确保新的设置生效。</p>
<p>Fix all of the following violations that were found against the API server:<br>修复针对 API 服务器发现的所有以下违规行为：<br>Ensure that the 1.2.7 –authorization-mode FAIL argument is not set to AlwaysAllow<br>Ensure that the 1.2.8 –authorization-mode FAIL argument includes Node<br>Ensure that the 1.2.9 –authorization-mode FAIL argument includes RBAC<br>Ensure that the 1.2.18 –insecure-bind-address FAIL argument is not set<br>Ensure that the 1.2.19 –insecure-port FAIL argument is set to 0</p>
<p>Fix all of the following violations that were found against the kubelet:<br>修复针对 kubelet 发现的所有以下违规行为：<br>Ensure that the 4.2.1 –anonymous-auth FAIL argument is set to false<br>Ensure that the 4.2.2 –authorization-mode FAIL argument is not set to AlwaysAllow<br>Use <code>Webhook</code> authn&#x2F;authz where possible. 注意：尽可能使用 Webhook authn&#x2F;authz。</p>
<p>Fix all of the following violations that were found against etcd:<br>修复针对 etcd 发现的所有以下违规行为：<br>Ensure that the 4.2.1 –client-cert-auth FAIL argument is set to true</p>
</blockquote>
<p><code>因为是直接下载二进制文件执行命令 所以需要指定一些配置文件 apt包安装的直接run即可 </code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kube-bench --config-dir `<span class="hljs-built_in">pwd</span>`/cfg --config `<span class="hljs-built_in">pwd</span>`/cfg/config.yaml run --targets master | grep FAIL<br>[FAIL] 1.1.12 Ensure that the etcd data directory ownership is <span class="hljs-built_in">set</span> to etcd:etcd (Automated)<br>[FAIL] 1.2.6 Ensure that the --kubelet-certificate-authority argument is <span class="hljs-built_in">set</span> as appropriate (Automated)<br>[FAIL] 1.2.16 Ensure that the admission control plugin PodSecurityPolicy is <span class="hljs-built_in">set</span> (Automated)<br>[FAIL] 1.2.19 Ensure that the --insecure-port argument is <span class="hljs-built_in">set</span> to 0 (Automated)<br>[FAIL] 1.2.21 Ensure that the --profiling argument is <span class="hljs-built_in">set</span> to <span class="hljs-literal">false</span> (Automated)<br>[FAIL] 1.2.22 Ensure that the --audit-log-path argument is <span class="hljs-built_in">set</span> (Automated)<br>[FAIL] 1.2.23 Ensure that the --audit-log-maxage argument is <span class="hljs-built_in">set</span> to 30 or as appropriate (Automated)<br>[FAIL] 1.2.24 Ensure that the --audit-log-maxbackup argument is <span class="hljs-built_in">set</span> to 10 or as appropriate (Automated)<br>[FAIL] 1.2.25 Ensure that the --audit-log-maxsize argument is <span class="hljs-built_in">set</span> to 100 or as appropriate (Automated)<br>[FAIL] 1.3.2 Ensure that the --profiling argument is <span class="hljs-built_in">set</span> to <span class="hljs-literal">false</span> (Automated)<br>[FAIL] 1.4.1 Ensure that the --profiling argument is <span class="hljs-built_in">set</span> to <span class="hljs-literal">false</span> (Automated)<br>11 checks FAIL<br>11 checks FAIL<br></code></pre></td></tr></table></figure>

<p><img src="/home/shanwen/Documents/Note/Pic/image-20240521095655578.png" srcset="/img/loading.gif" lazyload alt="image-20240521095655578"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# <span class="hljs-built_in">chown</span> etcd:etcd /var/lib/etcd/<br></code></pre></td></tr></table></figure>

<p><img src="/home/shanwen/Documents/Note/Pic/image-20240521095746330.png" srcset="/img/loading.gif" lazyload alt="image-20240521095746330"></p>
<p>跟着提示执行即可 执行完操作后重启kubelet进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload ; systemctl restart kubelet<br></code></pre></td></tr></table></figure>

<h1 id="Trivy镜像扫描"><a href="#Trivy镜像扫描" class="headerlink" title="Trivy镜像扫描"></a>Trivy镜像扫描</h1><blockquote>
<p><strong>容器镜像安全</strong></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/v0.51/">https://aquasecurity.github.io/trivy/v0.51/</a></p>
<h2 id="什么是Trivy"><a href="#什么是Trivy" class="headerlink" title="什么是Trivy"></a>什么是Trivy</h2><p>Trivy是一款全面且多功能的安全扫描程序。Trivy 具有查找安全问题的<em>扫描器</em>，并针对可以找到这些问题<em>的地方</em>。<code>对镜像层面的安全保障</code></p>
<p>目标（Trivy 可以扫描的目标）：</p>
<ul>
<li>容器镜像</li>
<li>文件系统</li>
<li>Git Repository （远程）</li>
<li>虚拟机映像</li>
<li>Kubernetes</li>
<li>AWS系统</li>
</ul>
<blockquote>
<p>官网说支持容器运行 考试是宿主机二进制程序</p>
</blockquote>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/v0.51/getting-started/installation/">https://aquasecurity.github.io/trivy/v0.51/getting-started/installation/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://github.com/aquasecurity/trivy/releases/download/v0.51.2/trivy_0.51.2_Linux-64bit.tar.gz<br><span class="hljs-built_in">mv</span> trivy /bin/<br><br>root@Kmaster:~# trivy -v<br>Version: 0.51.2<br></code></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/v0.51/docs/references/configuration/cli/trivy_image/">https://aquasecurity.github.io/trivy/v0.51/docs/references/configuration/cli/trivy_image/</a></p>
<p>CKS考试只需要扫描出等级为 HIGH和CRITICAL的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# crictl images <br>IMAGE                                           TAG                 IMAGE ID            SIZE<br>docker.io/calico/cni                            v3.28.0             107014d9f4c89       209MB<br>docker.io/calico/csi                            v3.28.0             1a094aeaf1521       18.3MB<br>docker.io/calico/node-driver-registrar          v3.28.0             0f80feca743f4       23.5MB<br>docker.io/calico/node                           v3.28.0             4e42b6f329bc1       355MB<br>docker.io/calico/pod2daemon-flexvol             v3.28.0             587b28ecfc62e       13.4MB<br>docker.io/library/alpine                        latest              05455a08881ea       7.67MB<br>registry.k8s.io/coredns/coredns                 v1.11.1             cbb01a7bd410d       61.2MB<br>registry.k8s.io/etcd                            3.5.12-0            3861cfcd7c04c       151MB<br>registry.k8s.io/kube-apiserver                  v1.30.0             c42f13656d0b2       118MB<br>registry.k8s.io/kube-controller-manager         v1.30.0             c7aad43836fa5       112MB<br>registry.k8s.io/kube-proxy                      v1.30.0             a0bf559e280cf       85.9MB<br>registry.k8s.io/kube-scheduler                  v1.30.0             259c8277fcbbc       63MB<br>registry.k8s.io/metrics-server/metrics-server   v0.7.1              a24c7c057ec87       68.4MB<br>registry.k8s.io/pause                           3.6                 6270bb605e12e       690kB<br>registry.k8s.io/pause                           3.9                 e6f1816883972       750kB<br><br>root@Kmaster:~# trivy image | grep sever<br>  <span class="hljs-comment"># Filter by severities</span><br>  $ trivy image --severity HIGH,CRITICAL alpine:3.15<br>  -s, --severity strings           severities of security issues to be displayed (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL) (default [UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL])<br>2024-05-21T22:42:31+08:00	FATAL	Fatal error	Require at least 1 argument<br><br>root@Kmaster:~# trivy image --severity HIGH,CRITICAL  docker.io/library/alpine<br>2024-05-21T22:52:58+08:00	INFO	Vulnerability scanning is enabled<br>2024-05-21T22:52:58+08:00	INFO	Secret scanning is enabled<br>2024-05-21T22:52:58+08:00	INFO	If your scanning is slow, please try <span class="hljs-string">&#x27;--scanners vuln&#x27;</span> to <span class="hljs-built_in">disable</span> secret scanning<br>2024-05-21T22:52:58+08:00	INFO	Please see also https://aquasecurity.github.io/trivy/v0.51/docs/scanner/secret/#recommendation <span class="hljs-keyword">for</span> faster secret detection<br>2024-05-21T22:53:02+08:00	INFO	Detected OS	family=<span class="hljs-string">&quot;alpine&quot;</span> version=<span class="hljs-string">&quot;3.19.1&quot;</span><br>2024-05-21T22:53:02+08:00	INFO	[alpine] Detecting vulnerabilities...	os_version=<span class="hljs-string">&quot;3.19&quot;</span> repository=<span class="hljs-string">&quot;3.19&quot;</span> pkg_num=15<br>2024-05-21T22:53:02+08:00	INFO	Number of language-specific files	num=0<br><br>docker.io/library/alpine (alpine 3.19.1)<br><br>Total: 0 (HIGH: 0, CRITICAL: 0)<br></code></pre></td></tr></table></figure>

<h2 id="Task-2"><a href="#Task-2" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>使用 Trivy 开源容器扫描器检测 namespace kamino 中 Pod 使用的具有严重漏洞的镜像。<br>查找具有 High 或 Critical 严重性漏洞的镜像，并删除使用这些镜像的 Pod。<br>注意：Trivy 仅安装在 cluster 的 master 节点上，在工作节点上不可使用。你必须切换到 cluster 的 master 节点才能使用 Trivy 。</p>
<p>Use the Trivy open-source container scanner to detect images with severe vulnerabilities used by Pods in the namespace <code>kamino</code>.<br>Look for images with <code>High</code> or <code>Critical</code> severity vulnerabilities, and delete the Pods that use those images.</p>
<p>Trivy is pre-installed on the cluster’s <code>master</code> node only; it is not available on the base system or the worker nodes. You’ll have to connect to the cluster’s master node to use <code>Trivy</code>.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl config get-contexts  <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   kamino<br><br>root@Kmaster:~# kubectl get pod <br>NAME   READY   STATUS    RESTARTS   AGE<br>os1    1/1     Running   0          84s<br><br>root@Kmaster:~# kubectl describe pod/os1 | grep  Image<br>    Image:         alpine<br>    Image ID:      docker.io/library/alpine@sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0<br>    <br>root@Kmaster:~# trivy image --severity HIGH,CRITICAL  docker.io/library/alpine<br><br>root@Kmaster:~# kubectl delete pod/os1 <br>pod <span class="hljs-string">&quot;os1&quot;</span> deleted<br><br>root@Kmaster:~# kubectl get pod <br>No resources found <span class="hljs-keyword">in</span> kamino namespace.<br></code></pre></td></tr></table></figure>

<h1 id="Sysdig-Falco"><a href="#Sysdig-Falco" class="headerlink" title="Sysdig &amp; Falco"></a>Sysdig &amp; Falco</h1><blockquote>
<p><strong>容器在运行时的性能安全检测</strong></p>
</blockquote>
<h2 id="什么是Sysdig-Falco"><a href="#什么是Sysdig-Falco" class="headerlink" title="什么是Sysdig &amp; Falco"></a>什么是Sysdig &amp; Falco</h2><p>主要是检测 容器在运行时、系统、发生的故障和错误  我们选择Sysdig</p>
<p>它们都出自同一个公司 Sysdig可以集成Falco</p>
<p><img src="/home/shanwen/Documents/Note/Pic/image-20240523095912931.png" srcset="/img/loading.gif" lazyload alt="image-20240523095912931"></p>
<h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://github.com/draios/sysdig/wiki/How-to-Install-Sysdig-for-Linux">https://github.com/draios/sysdig/wiki/How-to-Install-Sysdig-for-Linux</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# curl -s https://download.sysdig.com/stable/install-sysdig |  bash<br>root@Kmaster:~# sysdig --version<br>sysdig version 0.37.1<br></code></pre></td></tr></table></figure>

<h4 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h4><p><a target="_blank" rel="noopener" href="https://github.com/draios/sysdig/wiki/Sysdig-Examples#this-is-an-ever-growing-list-of-cool-things-you-can-do-with-sysdig-commands">https://github.com/draios/sysdig/wiki/Sysdig-Examples#this-is-an-ever-growing-list-of-cool-things-you-can-do-with-sysdig-commands</a></p>
<p>支持各种系统检测</p>
<p><img src="/home/shanwen/Documents/Note/Pic/image-20240523100804811.png" srcset="/img/loading.gif" lazyload alt="image-20240523100804811"></p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# sysdig -M 30 -p <span class="hljs-string">&quot;%evt.time,%user.uid,%proc.name&quot;</span> --cri=/run/crio/crio.sock container.name=calico-node &gt; 1.txt<br>root@Kmaster:~# <span class="hljs-built_in">cat</span> 1.txt | <span class="hljs-built_in">head</span> -n 10<br>10:18:10.384404369,0,calico-node<br>10:18:10.384410320,0,calico-node<br>10:18:10.384411246,0,calico-node<br>10:18:10.384416788,0,calico-node<br>10:18:10.384420962,0,calico-node<br>10:18:10.384425829,0,calico-node<br>10:18:10.384426129,0,calico-node<br>10:18:10.384427228,0,calico-node<br>10:18:10.384430884,0,calico-node<br>10:18:10.384431839,0,calico-node<br></code></pre></td></tr></table></figure>

<h2 id="Task-3"><a href="#Task-3" class="headerlink" title="Task"></a>Task</h2><p>The tools are pre-installed on the cluster’s worker node only, they are not avaliable on the base system or the master node.<br>Using the tool of you choice (including any non pre-install tool) analyse the container’s behavior for at least 30 seconds, using filers that detect newly spawing and executing processes, store an incident file at &#x2F;opt&#x2F;KSR00101&#x2F;incidents&#x2F;summary, containing the detected incidents one per line in the follwing format:<br>注：这些工具只预装在 cluster 的工作节点，不在 master 节点。<br>使用工具至少分析 30 秒，使用过滤器检查生成和执行的进程，将事件写到 &#x2F;opt&#x2F;KSR00101&#x2F;incidents&#x2F;summary 文件中，其中包含检测的事件, 每个单独一行<br>格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span>timestamp<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span>uid<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span>processName<span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 查看帮助</span><br>root@Kmaster:~# sysdig -h <br><span class="hljs-comment">##  $ sysdig -p&quot;%evt.arg.name&quot; proc.name=cat and evt.type=open</span><br><span class="hljs-comment">## 查看支持的元数据</span><br>root@Kmaster:~# sysdig -l<br><br>root@Kmaster:~# crictl ps<br>CONTAINER           IMAGE                                                              CREATED             STATE               NAME                        ATTEMPT             POD ID              POD<br>9778368a91947       cbb01a7bd410dc08ba382018ab909a674fb0e48687f0c00797ed5bc34fcc6bb4   2 hours ago         Running             coredns                     13                  9fd24b3395674       coredns-7db6d8ff4d-knl4n<br>b2fd07339d27c       cbb01a7bd410dc08ba382018ab909a674fb0e48687f0c00797ed5bc34fcc6bb4   2 hours ago         Running             coredns                     13                  efde693fddb29       coredns-7db6d8ff4d-2488w<br>48792c152524a       0f80feca743f4a84ddda4057266092db9134f9af9e20e12ea6fcfe51d7e3a020   2 hours ago         Running             csi-node-driver-registrar   16                  521a1f0260473       csi-node-driver-6fpwf<br>b08116240a04b       1a094aeaf1521e225668c83cbf63c0ec63afbdb8c4dd7c3d2aab0ec917d103de   2 hours ago         Running             calico-csi                  10                  521a1f0260473       csi-node-driver-6fpwf<br>d82ab6993fd99       4e42b6f329bc1d197d97f6d2a1289b9e9f4a9560db3a36c8cffb5e95e64e4b49   2 hours ago         Running             calico-node                 10                  204d6ccd4b7d2       calico-node-98h7p<br>561653935f875       a0bf559e280cf431fceb938087d59deeebcf29cbf3706746e07f7ac08e80ba0b   2 hours ago         Running             kube-proxy                  10                  35d43f689ef69       kube-proxy-fxb2p<br>36b4ab3932cdc       259c8277fcbbc9e1cf308bc0b50582a180eb8cb8929dc8b870fa16660934bced   2 hours ago         Running             kube-scheduler              19                  7cac591f6933f       kube-scheduler-kmaster<br>841a6aadbfc6f       c42f13656d0b2e905ee7977f67ea7a17715b24fae9daca1fcfb303cdb90728f0   2 hours ago         Running             kube-apiserver              2                   a953e5532ff43       kube-apiserver-kmaster<br>4d0fb3ac1f40e       3861cfcd7c04ccac1f062788eca39487248527ef0c0cfd477a83d7691a75a899   2 hours ago         Running             etcd                        13                  996b5246b57a7       etcd-kmaster<br>9b2233853ecc0       c7aad43836fa5bd41152db04ba4c90f8e9451c40e06488442242582e5e112b1b   2 hours ago         Running             kube-controller-manager     20                  f549db3fa0218       kube-controller-manager-kmaster<br><br>root@Kmaster:~# sysdig -l | grep -E <span class="hljs-string">&#x27;timestamp|container.name|uid|proc.name&#x27;</span><br>evt.time                      event timestamp as a <span class="hljs-keyword">time</span> string that includes the nanosecond part. <br>evt.time.s                    event timestamp as a <span class="hljs-keyword">time</span> string with no nanoseconds. <br>evt.time.iso8601              event timestamp <span class="hljs-keyword">in</span> ISO 8601 format, including nanoseconds and <span class="hljs-keyword">time</span> zone offset (<span class="hljs-keyword">in</span> UTC). <br>evt.datetime                  event timestamp as a <span class="hljs-keyword">time</span> string that includes the <span class="hljs-built_in">date</span>. <br>evt.datetime.s                event timestamp as a datetime string with no nanoseconds. <br>evt.rawtime                   absolute event timestamp, i.e. nanoseconds from epoch. <br>evt.rawtime.s                 <span class="hljs-built_in">integer</span> part of the event timestamp (e.g. seconds since epoch). <br>evt.rawtime.ns                fractional part of the absolute event timestamp. <br>                              will <span class="hljs-built_in">return</span> the events with timestamp with one second before the timestamp and one second <br>proc.name                     The process name (truncated after 16 characters) generating the event (task-&gt;<span class="hljs-built_in">comm</span>). <br>proc.pname                    The proc.name truncated after 16 characters) of the process generating the event. <br>proc.aname                    (ARG_ALLOWED) The proc.name (truncated after 16 characters) <span class="hljs-keyword">for</span> a specific process <br>                              proc.aname[1] retrieves the proc.name of the parent process, proc.aname[2] retrieves the <br>                              proc.name of the grandparent process, and so on. The current process<span class="hljs-string">&#x27;s proc.name line can </span><br><span class="hljs-string">proc.cmdline                  The concatenation of `proc.name + proc.args` (truncated after 4096 bytes) when starting </span><br><span class="hljs-string">proc.pcmdline                 The proc.cmdline (full command line (proc.name + proc.args)) of the parent of the process </span><br><span class="hljs-string">proc.acmdline                 (ARG_ALLOWED) The full command line (proc.name + proc.args) for a specific process </span><br><span class="hljs-string">proc.pid.ts                   Start of process as epoch timestamp in nanoseconds. </span><br><span class="hljs-string">proc.ppid.ts                  Start of parent process as epoch timestamp in nanoseconds. </span><br><span class="hljs-string">proc.exe_ino.ctime            Last status change time of executable file (inode-&gt;ctime) as epoch timestamp in </span><br><span class="hljs-string">proc.exe_ino.mtime            Last modification time of executable file (inode-&gt;mtime) as epoch timestamp in </span><br><span class="hljs-string">proc.pidns_init_start_ts      Start of PID namespace (container or non container pid namespace) as epoch timestamp in </span><br><span class="hljs-string">user.uid                      user ID. </span><br><span class="hljs-string">user.loginuid                 audit user id (auid), internally the loginuid is of type `uint32_t`. However, if an </span><br><span class="hljs-string">                              invalid uid corresponding to UINT32_MAX is encountered, it is returned as -1 to support </span><br><span class="hljs-string">user.loginname                audit user name (auid). </span><br><span class="hljs-string">container.name                The container name. In instances of userspace container engine lookup delays, this field </span><br><span class="hljs-string">container.start_ts            Container start as epoch timestamp in nanoseconds based on proc.pidns_init_start_ts and </span><br><span class="hljs-string">fd.uid                        a unique identifier for the FD, created by chaining the FD number and the thread ID. </span><br><span class="hljs-string">                              field points to `k8s.pod.uid`; however, the pod ID typically refers to the pod sandbox </span><br><span class="hljs-string">                              ID. We recommend using the semantically more accurate `k8s.pod.uid` field. This field is </span><br><span class="hljs-string">k8s.pod.uid                   The Kubernetes pod UID, e.g. 3e41dc6b-08a8-44db-bc2a-3724b18ab19a. Note that the pod UID </span><br><span class="hljs-string"></span><br><span class="hljs-string">### -M 分析容器30秒，-p 指定事件保存格式，--cri 指定容器运行时，并且保存到指定文件路径中</span><br><span class="hljs-string">root@Kmaster:~# sysdig -M 30 -p &quot;%evt.time,%user.uid,%proc.name&quot; container.name=calico-node &gt; /path/fileName.txt</span><br><span class="hljs-string">## 添加容器运行时路径执行 </span><br><span class="hljs-string">root@Kmaster:~# sysdig -M 30 -p &quot;%evt.time,%user.uid,%proc.name&quot; --cri /run/crio/crio.sock container.name=calico-node &gt; /path/fileName.txt</span><br></code></pre></td></tr></table></figure>

<h1 id="ServiceAcount"><a href="#ServiceAcount" class="headerlink" title="ServiceAcount"></a>ServiceAcount</h1><blockquote>
<p><strong>Pod对kube-apiserver访问安全</strong></p>
</blockquote>
<h2 id="什么是ServiceAcount"><a href="#什么是ServiceAcount" class="headerlink" title="什么是ServiceAcount"></a>什么是ServiceAcount</h2><p>Role(Cluster Role)指定了能访问的资源和权限 RoleBinding(Cluster RoleBinDing)将Role(Cluster Role)绑定给User或是ServiceAcount</p>
<p>User: 管理员执行命令对kube-apiserver资源的访问权限</p>
<p>ServiceAcount: Pod对kube-apiserver资源的访问权限</p>
<h2 id="Task-4"><a href="#Task-4" class="headerlink" title="Task"></a>Task</h2><blockquote>
<ol>
<li>在现有 namespace qa 中创建一个名为 backend-sa 的新 ServiceAccount， 确保此 ServiceAccount 不自动挂载secrets。</li>
<li>使用 &#x2F;cks&#x2F;9&#x2F;pod9.yaml 中的清单文件来创建一个 Pod。</li>
<li>最后，清理 namespace qa 中任何未使用的 ServiceAccount。</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:~$ kubectl config get-contexts <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   qa<br></code></pre></td></tr></table></figure>

<h3 id="不自动挂载Token"><a href="#不自动挂载Token" class="headerlink" title="不自动挂载Token"></a>不自动挂载Token</h3><p>参考k8s官网</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">backend-sa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">qa</span>              <span class="hljs-comment">#因为我默认在qa ns下 kubectl apply -f 直接在该ns执行 如果不在qa ns 需要添加此字段</span><br><span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl apply -f task5SA.yaml<br>serviceaccount/backend-sa created<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get sa<br>NAME         SECRETS   AGE<br>backend-sa   0         3s<br>default      0         7m18s   <span class="hljs-comment">##每个NS下默认都会有个default</span><br></code></pre></td></tr></table></figure>

<p>使用文件创建Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ <span class="hljs-built_in">cat</span> task5Pod9.yaml<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  creationTimestamp: null<br>  labels:<br>    run: sa-qa<br>  name: sa-qa<br>  namespace: qa<br>spec:<br>  serviceAccountName: test2<br>  containers:<br>  - image: nginx:1.9<br>    imagePullPolicy: IfNotPresent<br>    name: sa-qa<br>    resources: &#123;&#125;<br>  dnsPolicy: ClusterFirst<br>  restartPolicy: Always<br>status: &#123;&#125;<br><br><span class="hljs-comment">## 应用清单文件</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl apply -f task5Pod9.yaml<br>Error from server (Forbidden): error when creating <span class="hljs-string">&quot;task5Pod9.yaml&quot;</span>: pods <span class="hljs-string">&quot;sa-qa&quot;</span> is forbidden: error looking up service account qa/test2: serviceaccount <span class="hljs-string">&quot;test2&quot;</span> not found<br><br><span class="hljs-comment">## 报错 没有找到serviceaccount test2</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get sa -n qa<br>NAME         SECRETS   AGE<br>backend-sa   0         2d20h<br>default      0         2d20h<br>test1        0         2d20h<br><br><span class="hljs-comment">## 修改文件使用新创建的backend-sa serviceAccount</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ <span class="hljs-built_in">cat</span> task5Pod9.yaml<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  creationTimestamp: null<br>  labels:<br>    run: sa-qa<br>  name: sa-qa<br>  namespace: qa<br>spec:<br>  serviceAccountName: backend-sa<br>  containers:<br>  - image: nginx:1.9<br>    imagePullPolicy: IfNotPresent<br>    name: sa-qa<br>    resources: &#123;&#125;<br>  dnsPolicy: ClusterFirst<br>  restartPolicy: Always<br>status: &#123;&#125;<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl apply -f task5Pod9.yaml<br>pod/sa-qa created<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get pod <br>NAME    READY   STATUS    RESTARTS   AGE<br>a1      1/1     Running   0          6m14s<br>sa-qa   1/1     Running   0          94s<br></code></pre></td></tr></table></figure>

<h3 id="删除没有使用的SA"><a href="#删除没有使用的SA" class="headerlink" title="删除没有使用的SA"></a>删除没有使用的SA</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 查看使用中的serviceAccount</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe pod -n qa | grep -i account<br>Service Account:  default<br>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jsn92 (ro)<br>Service Account:  backend-sa<br><br><span class="hljs-comment">## 查看ns下存在的sa</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get sa -n qa<br>NAME         SECRETS   AGE<br>backend-sa   0         2d20h<br>default      0         2d20h<br>test1        0         2d20h<br><br><span class="hljs-comment">## 删除未使用的test1</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl delete sa/test1 <br>serviceaccount <span class="hljs-string">&quot;test1&quot;</span> deleted<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get sa<br>NAME         SECRETS   AGE<br>backend-sa   0         2d20h<br>default      0         2d20h<br></code></pre></td></tr></table></figure>

<h1 id="默认网络策略"><a href="#默认网络策略" class="headerlink" title="默认网络策略"></a>默认网络策略</h1><p>一个默认拒绝（default-deny）的NetworkPolicy可避免在未定义任何其他NetworkPolicy的namespace中意外公开Pod。</p>
<h2 id="Task-5"><a href="#Task-5" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>为所有类型为 <strong>Ingress+Egress</strong> 的流量在 namespace <strong>testing</strong> 中创建一个名为 <strong>denypolicy</strong> 的新默认拒绝 NetworkPolicy 。<br>此新的 NetworkPolicy 必须拒绝 namespace <strong>testing</strong> 中的所有的 <strong>Ingress + Egress</strong> 流量。<br>将新创建的默认拒绝 NetworkPolicy 应用在 namespace <strong>testing</strong> 中运行的所有 Pod 。</p>
<p>你可以在 &#x2F;cks&#x2F;net&#x2F;p1.yaml 找到一个模板清单文件。</p>
</blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F">https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/#默认拒绝所有入口和所有出站流量</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">testing</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">policyTypes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl apply -f task6NetworkPolicy.yaml<br>networkpolicy.networking.k8s.io/denypolicy created<br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ <span class="hljs-built_in">cat</span> task6NetworkPolicy.yaml<br>apiVersion: networking.k8s.io/v1<br>kind: NetworkPolicy<br>metadata:<br>  name: denypolicy<br>  namespace: testing<br>spec:<br>  podSelector: &#123;&#125;<br>  policyTypes:<br>  - Ingress<br>  - Egress<br></code></pre></td></tr></table></figure>

<h1 id="RBAC-RoleBinding"><a href="#RBAC-RoleBinding" class="headerlink" title="RBAC - RoleBinding"></a>RBAC - RoleBinding</h1><p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole</a></p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><blockquote>
<p>绑定到 Pod 的 ServiceAccount 的 Role 授予过度宽松的权限。完成以下项目以减少权限集。</p>
</blockquote>
<h2 id="Task-6"><a href="#Task-6" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>一个名为 <strong>web-pod</strong> 的现有 Pod 已在 namespace <strong>db</strong> 中运行。<br>编辑绑定到 Pod 的 ServiceAccount <strong>service-account-web</strong> 的现有 Role，仅允许只对 <strong>services</strong> 类型的资源执行 <strong>get</strong> 操作。<br>在 namespace <strong>db</strong> 中创建一个名为 <strong>role-2</strong> ，并仅允许只对 <strong>namespaces</strong> 类型的资源执行 <strong>delete</strong> 操作的新 Role。<br>创建一个名为 <strong>role-2-binding</strong> 的新 RoleBinding，将新创建的 Role 绑定到 Pod 的 ServiceAccount。</p>
<p>注意：请勿删除现有的 RoleBinding。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen$ kubectl config set-context --current --namespace db<br>Context <span class="hljs-string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.<br><br>shanwen@Arch:/home/shanwen$ kubectl config get-contexts <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   db<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl apply -f 1.yaml<br>pod/web-pod created<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get pod<br>NAME      READY   STATUS    RESTARTS   AGE<br>web-pod   1/1     Running   0          6s<br><br><span class="hljs-comment">## 查看pod挂载的sa</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe pod/web-pod | grep Service<br>Service Account:  web-pod-sa<br><br><span class="hljs-comment">## 查看sa绑定的role</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl get rolebindings.rbac.authorization.k8s.io -o wide <br>NAME      ROLE                AGE   USERS   GROUPS   SERVICEACCOUNTS<br>web-pod   Role/web-pod-role   19m                    db/web-pod-sa<br><br><span class="hljs-comment">## 修改role配置</span><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl edit role/web-pod-role<br><span class="hljs-comment"># Please edit the object below. Lines beginning with a &#x27;#&#x27; will be ignored,</span><br><span class="hljs-comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><br><span class="hljs-comment"># reopened with the relevant failures.</span><br><span class="hljs-comment">#</span><br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: Role<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2024-05-30T08:21:59Z&quot;</span><br>  name: web-pod-role<br>  namespace: db<br>  resourceVersion: <span class="hljs-string">&quot;288424&quot;</span><br>  uid: a55d12bd-b6ad-4ae8-950a-f8860cf96135<br>rules:<br>- apiGroups:<br>  - <span class="hljs-string">&quot;&quot;</span><br>  resources:<br>  - services<br>  verbs:<br>  - get<br>  <br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe role/web-pod-role <br>Name:         web-pod-role<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>PolicyRule:<br>  Resources  Non-Resource URLs  Resource Names  Verbs<br>  ---------  -----------------  --------------  -----<br>  services   []                 []              [get]<br><br></code></pre></td></tr></table></figure>

<h3 id="创建新role"><a href="#创建新role" class="headerlink" title="创建新role"></a>创建新role</h3><p>在 namespace <strong>db</strong> 中创建一个名为 <strong>role-2</strong> ，并仅允许只对 <strong>namespaces</strong> 类型的资源执行 <strong>delete</strong> 操作的新 Role。</p>
<p>创建一个名为 <strong>role-2-binding</strong> 的新 RoleBinding，将新创建的 Role 绑定到 Pod 的 ServiceAccount。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl create role role-2 --verb delete --resource namespace<br>role.rbac.authorization.k8s.io/role-2 created<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe role/role-2 <br>Name:         role-2<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>PolicyRule:<br>  Resources   Non-Resource URLs  Resource Names  Verbs<br>  ---------   -----------------  --------------  -----<br>  namespaces  []                 []              [delete]<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe pod/web-pod | grep Service<br>Service Account:  web-pod-sa<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl create rolebinding role-2-binding --serviceaccount db:web-pod-sa --role role-2<br>rolebinding.rbac.authorization.k8s.io/role-2-binding created<br><br>shanwen@Arch:/home/shanwen/WorkSpace/k8s/CKS$ kubectl describe rolebindings.rbac.authorization.k8s.io role-2-binding <br>Name:         role-2-binding<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>Role:<br>  Kind:  Role<br>  Name:  role-2<br>Subjects:<br>  Kind            Name        Namespace<br>  ----            ----        ---------<br>  ServiceAccount  web-pod-sa  db<br></code></pre></td></tr></table></figure>



<h1 id="日志审计-log-audit"><a href="#日志审计-log-audit" class="headerlink" title="日志审计 log audit"></a>日志审计 log audit</h1><p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/">https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/</a></p>
<h2 id="Task-7"><a href="#Task-7" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p> 在cluster中启用审计日志。为此，请启用日志后端，并确保：</p>
<ul>
<li>日志存储在 <strong>&#x2F;var&#x2F;log&#x2F;kubernetes&#x2F;audit-logs.txt</strong></li>
<li>日志文件能保留 <strong>10</strong> 天</li>
<li>最多保留 <strong>2</strong> 个旧审计日志文件</li>
</ul>
<p><strong>&#x2F;etc&#x2F;kubernetes&#x2F;logpolicy&#x2F;sample-policy.yaml</strong> 提供了基本策略。它仅指定不记录的内容。</p>
<p>注意：基本策略位于 cluster 的 master 节点上。</p>
</blockquote>
<blockquote>
<p>编辑和扩展基本策略以记录：</p>
<ul>
<li>RequestResponse 级别的 <strong>persistentvolumes</strong> 更改</li>
<li>namespace <strong>front-apps</strong> 中 <strong>configmaps</strong> 更改的请求体</li>
<li><strong>Metadata</strong> 级别的所有 namespace 中的 ConfigMap 和 Secret 的更改</li>
</ul>
<p>此外，添加一个全方位的规则以在 <strong>Metadata</strong> 级别记录所有其他请求。</p>
<p>注意：不要忘记应用修改后的策略。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## /etc/kubernetes/logpolicy/sample-policy.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">audit.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span><br><span class="hljs-comment"># Don&#x27;t generate audit events for all requests in RequestReceived stage.</span><br><span class="hljs-attr">omitStages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Don&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">users:</span> [<span class="hljs-string">&quot;system:kube-proxy&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;watch&quot;</span>]<br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>, <span class="hljs-string">&quot;services&quot;</span>]<br>  <span class="hljs-comment"># Don&#x27;t log authenticated requests to certain non-resource URL paths.    </span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">userGroups:</span> [<span class="hljs-string">&quot;system:authenticated&quot;</span>]<br>    <span class="hljs-attr">nonResourceURLs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/api*&quot;</span>  <span class="hljs-comment"># Wildcard matching.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/version&quot;</span><br>  <span class="hljs-comment"># Please do not delete the above rule content, you can continue add it below.</span><br></code></pre></td></tr></table></figure>

<h3 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">audit.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span><br><span class="hljs-comment"># Don&#x27;t generate audit events for all requests in RequestReceived stage.</span><br><span class="hljs-attr">omitStages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Don&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">users:</span> [<span class="hljs-string">&quot;system:kube-proxy&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;watch&quot;</span>]<br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>, <span class="hljs-string">&quot;services&quot;</span>]<br>  <span class="hljs-comment"># Don&#x27;t log authenticated requests to certain non-resource URL paths.    </span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">userGroups:</span> [<span class="hljs-string">&quot;system:authenticated&quot;</span>]<br>    <span class="hljs-attr">nonResourceURLs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/api*&quot;</span>  <span class="hljs-comment"># Wildcard matching.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/version&quot;</span><br>  <span class="hljs-comment"># Please do not delete the above rule content, you can continue add it below.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">RequestResponse</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Request</span><br>    <span class="hljs-attr">namespace:</span> [<span class="hljs-string">&quot;front-apps&quot;</span>]<br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;secrets&quot;</span>, <span class="hljs-string">&quot;configmaps&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">omitStages:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><ul>
<li>日志存储在 <strong>&#x2F;var&#x2F;log&#x2F;kubernetes&#x2F;audit-logs.txt</strong></li>
<li>日志文件能保留 <strong>10</strong> 天</li>
<li>最多保留 <strong>2</strong> 个旧审计日志文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## audit</span><br> - --audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml<br> - --audit-log-path=/var/log/kubernetes/audit-logs.txt<br> - --audit-log-maxage=10<br> - --audit-log-maxbackup=2<br></code></pre></td></tr></table></figure>

<p>挂载文件到apiserver</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## audit</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/kubernetes/</span><br>     <span class="hljs-attr">name:</span> <span class="hljs-string">audit-log</span><br>     <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kubernetes/logpolicy/sample-policy.yaml</span><br>     <span class="hljs-attr">name:</span> <span class="hljs-string">audit-cfg</span><br>     <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment">### audit</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span><br>     <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/kubernetes/</span><br>     <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">audit-log</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span><br>     <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/kubernetes/logpolicy/sample-policy.yaml</span><br>     <span class="hljs-attr">type:</span> <span class="hljs-string">File</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">audit-cfg</span><br></code></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:/etc/kubernetes/manifests# systemctl daemon-reload ; systemctl restart kubelet.service <br></code></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:/etc/kubernetes/manifests# <span class="hljs-built_in">tail</span> -n 1 /var/log/kubernetes/audit-logs.txt <br>&#123;<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Event&quot;</span>,<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;audit.k8s.io/v1&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;Metadata&quot;</span>,<span class="hljs-string">&quot;auditID&quot;</span>:<span class="hljs-string">&quot;7508c7b4-8e8e-4589-a5fa-1ac10260715c&quot;</span>,<span class="hljs-string">&quot;stage&quot;</span>:<span class="hljs-string">&quot;ResponseComplete&quot;</span>,<span class="hljs-string">&quot;requestURI&quot;</span>:<span class="hljs-string">&quot;/apis/coordination.k8s.io/v1/namespaces/tigera-operator/leases/operator-lock&quot;</span>,<span class="hljs-string">&quot;verb&quot;</span>:<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;user&quot;</span>:&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;system:serviceaccount:tigera-operator:tigera-operator&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-string">&quot;19cd83ff-1742-4321-9c84-478cadf4dd8e&quot;</span>,<span class="hljs-string">&quot;groups&quot;</span>:[<span class="hljs-string">&quot;system:serviceaccounts&quot;</span>,<span class="hljs-string">&quot;system:serviceaccounts:tigera-operator&quot;</span>,<span class="hljs-string">&quot;system:authenticated&quot;</span>],<span class="hljs-string">&quot;extra&quot;</span>:&#123;<span class="hljs-string">&quot;authentication.kubernetes.io/credential-id&quot;</span>:[<span class="hljs-string">&quot;JTI=65b87973-ae6f-441d-88bd-ab2549e1f199&quot;</span>],<span class="hljs-string">&quot;authentication.kubernetes.io/node-name&quot;</span>:[<span class="hljs-string">&quot;knode2&quot;</span>],<span class="hljs-string">&quot;authentication.kubernetes.io/node-uid&quot;</span>:[<span class="hljs-string">&quot;90b6d3e3-c79b-4fb2-b0bc-b11d7420741b&quot;</span>],<span class="hljs-string">&quot;authentication.kubernetes.io/pod-name&quot;</span>:[<span class="hljs-string">&quot;tigera-operator-76ff79f7fd-29mh2&quot;</span>],<span class="hljs-string">&quot;authentication.kubernetes.io/pod-uid&quot;</span>:[<span class="hljs-string">&quot;0337d83f-14ac-42bb-b47f-57da09440e8f&quot;</span>]&#125;&#125;,<span class="hljs-string">&quot;sourceIPs&quot;</span>:[<span class="hljs-string">&quot;192.168.10.52&quot;</span>],<span class="hljs-string">&quot;userAgent&quot;</span>:<span class="hljs-string">&quot;operator/v0.0.0 (linux/amd64) kubernetes/<span class="hljs-variable">$Format</span>/leader-election&quot;</span>,<span class="hljs-string">&quot;objectRef&quot;</span>:&#123;<span class="hljs-string">&quot;resource&quot;</span>:<span class="hljs-string">&quot;leases&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;tigera-operator&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;operator-lock&quot;</span>,<span class="hljs-string">&quot;apiGroup&quot;</span>:<span class="hljs-string">&quot;coordination.k8s.io&quot;</span>,<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>&#125;,<span class="hljs-string">&quot;responseStatus&quot;</span>:&#123;<span class="hljs-string">&quot;metadata&quot;</span>:&#123;&#125;,<span class="hljs-string">&quot;code&quot;</span>:200&#125;,<span class="hljs-string">&quot;requestReceivedTimestamp&quot;</span>:<span class="hljs-string">&quot;2024-06-06T08:48:35.673030Z&quot;</span>,<span class="hljs-string">&quot;stageTimestamp&quot;</span>:<span class="hljs-string">&quot;2024-06-06T08:48:35.677455Z&quot;</span>,<span class="hljs-string">&quot;annotations&quot;</span>:&#123;<span class="hljs-string">&quot;authorization.k8s.io/decision&quot;</span>:<span class="hljs-string">&quot;allow&quot;</span>,<span class="hljs-string">&quot;authorization.k8s.io/reason&quot;</span>:<span class="hljs-string">&quot;RBAC: allowed by ClusterRoleBinding \&quot;tigera-operator\&quot; of ClusterRole \&quot;tigera-operator\&quot; to ServiceAccount \&quot;tigera-operator/tigera-operator\&quot;&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>





<h1 id="创建Secret"><a href="#创建Secret" class="headerlink" title="创建Secret"></a>创建Secret</h1><p>参考：</p>
<p>创建 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret">https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret</a></p>
<p>使用 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-a-secret">https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-a-secret</a></p>
<h2 id="Task-8"><a href="#Task-8" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>在 namespace <strong>istio-system</strong> 中获取名为 <strong>db1-test</strong> 的现有 secret 的内容<br>将 <strong>username</strong> 字段存储在名为 <strong>&#x2F;cks&#x2F;sec&#x2F;user.txt</strong> 的文件中，并将<strong>password</strong> 字段存储在名为 <strong>&#x2F;cks&#x2F;sec&#x2F;pass.txt</strong> 的文件中。<br>注意：你必须创建以上两个文件，他们还不存在。</p>
<p>注意：不要在以下步骤中使用&#x2F;修改先前创建的文件，如果需要，可以创建新的临时文件。</p>
<p>在 <strong>istio-system</strong> namespace 中创建一个名为 <strong>db2-test</strong> 的新 secret ，内容如下：<br><strong>username : production-instance</strong><br><strong>password : KvLftKgs4aVH</strong><br>最后，创建一个新的 Pod ，它可以通过卷访问 secret <strong>db2-test</strong> ：<br>Pod 名称 <strong>secret-pod</strong><br>Namespace <strong>istio-system</strong><br>容器名 <strong>dev-container</strong><br>镜像 <strong>nginx</strong><br>卷名 <strong>secret-volume</strong><br>挂载路径 <strong>&#x2F;etc&#x2F;secret</strong></p>
</blockquote>
<p>环境模拟</p>
<p>由于没有db1-test 只能自己写一个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen$ kubectl create secret generic db1-test --from-literal username=shanwen --from-literal passwd=shanwenPW<br><br>shanwen@Arch:/home/shanwen$ kubectl get  secrets db1-test -o yaml<br>apiVersion: v1<br>data:<br>  passwd: c2hhbndlblBX<br>  username: c2hhbndlbg==<br>kind: Secret<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2024-05-31T09:13:00Z&quot;</span><br>  name: db1-test<br>  namespace: istio-system<br>  resourceVersion: <span class="hljs-string">&quot;299838&quot;</span><br>  uid: 0d3b1b6a-c15d-437d-b830-a758965252dd<br><span class="hljs-built_in">type</span>: Opaque<br><br>shanwen@Arch:/home/shanwen$ <span class="hljs-built_in">echo</span> c2hhbndlblBX  | <span class="hljs-built_in">base64</span> -d<br>shanwenPWshanwen@Arch:/home/shanwen$ <span class="hljs-built_in">echo</span> c2hhbndlbg==  | <span class="hljs-built_in">base64</span> -d<br>shanwenshanwen@Arch:/home/shanwen$ <br></code></pre></td></tr></table></figure>

<p>将 <strong>username</strong> 字段存储在名为 <strong>&#x2F;cks&#x2F;sec&#x2F;user.txt</strong> 的文件中，并将<strong>password</strong> 字段存储在名为 <strong>&#x2F;cks&#x2F;sec&#x2F;pass.txt</strong> 的文件中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">hanwen@Arch:/home/shanwen$ kubectl get secrets db1-test -o yaml<br>apiVersion: v1<br>data:<br>  passwd: c2hhbndlblBX<br>  username: c2hhbndlbg==<br>kind: Secret<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2024-05-31T09:13:00Z&quot;</span><br>  name: db1-test<br>  namespace: istio-system<br>  resourceVersion: <span class="hljs-string">&quot;299838&quot;</span><br>  uid: 0d3b1b6a-c15d-437d-b830-a758965252dd<br><span class="hljs-built_in">type</span>: Opaque<br>shanwen@Arch:/home/shanwen$ <span class="hljs-built_in">echo</span> c2hhbndlblBX &gt; /cks/sec/user.txt ; <span class="hljs-built_in">echo</span> c2hhbndlbg== &gt; /cks/sec/pass.txt<br></code></pre></td></tr></table></figure>

<p>在 <strong>istio-system</strong> namespace 中创建一个名为 <strong>db2-test</strong> 的新 secret </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen$ kubectl create secret generic db2-test --from-literal username=production-instance --from-literal password=KvLftKgs4aVH<br>secret/db2-<span class="hljs-built_in">test</span> created<br>shanwen@Arch:/home/shanwen$ kubectl get secrets db2-test -o yaml<br>apiVersion: v1<br>data:<br>  password: S3ZMZnRLZ3M0YVZI<br>  username: cHJvZHVjdGlvbi1pbnN0YW5jZQ==<br>kind: Secret<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2024-05-31T09:23:09Z&quot;</span><br>  name: db2-test<br>  namespace: istio-system<br>  resourceVersion: <span class="hljs-string">&quot;301045&quot;</span><br>  uid: 6da0d4d7-5923-488a-8b93-53daaf2dd8c6<br><span class="hljs-built_in">type</span>: Opaque<br><br>shanwen@Arch:/home/shanwen$ <span class="hljs-built_in">echo</span> S3ZMZnRLZ3M0YVZI | <span class="hljs-built_in">base64</span> -d<br>KvLftKgs4aVH<br>shanwen@Arch:/home/shanwen$ <span class="hljs-built_in">echo</span> cHJvZHVjdGlvbi1pbnN0YW5jZQ== | <span class="hljs-built_in">base64</span> -d<br>production-instance<br></code></pre></td></tr></table></figure>

<p>挂载到pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl run secret-pod --namespace  istio-system --image nginx --image-pull-policy IfNotPresent --dry-run=client -o yaml &gt; task9SecretsPod.yaml<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ vim task9SecretsPod.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">secret-pod</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">secret-pod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">istio-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">secret-pod</span><br>    <span class="hljs-attr">resources:</span> &#123;&#125;<br>  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br><span class="hljs-attr">status:</span> &#123;&#125;	<br></code></pre></td></tr></table></figure>

<p>编辑后</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">secret-pod</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">secret-pod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">istio-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">dev-container</span>             <span class="hljs-comment">##modify</span><br>    <span class="hljs-attr">resources:</span> &#123;&#125;<br>    <span class="hljs-attr">volumeMounts:</span>                   <span class="hljs-comment">##modify</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span>           <span class="hljs-comment">##modify</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/secret</span>        <span class="hljs-comment">##modify</span><br>  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">volumes:</span>                          <span class="hljs-comment">##modify   </span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span> 			<span class="hljs-comment">##modify</span><br>    <span class="hljs-attr">secret:</span> 						<span class="hljs-comment">##modify</span><br>      <span class="hljs-attr">secretName:</span> <span class="hljs-string">db2-test</span> 			<span class="hljs-comment">##modify</span><br><span class="hljs-attr">status:</span> &#123;&#125;	<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl  apply -f task9SecretsPod.yaml<br>pod/secret-pod created<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get pod<br>NAME         READY   STATUS    RESTARTS   AGE<br>secret-pod   1/1     Running   0          2s<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get pod -o wide <br>NAME         READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES<br>secret-pod   1/1     Running   0          5m37s   10.244.195.165   knode1   &lt;none&gt;           &lt;none&gt;<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ ssh root@Knode1<br><br>root@Knode1:~# crictl  ps<br>CONTAINER           IMAGE                                                              CREATED             STATE               NAME                        ATTEMPT             POD ID              POD<br>4bbe542db01a3       e784f4560448b14a66f55c26e1b4dad2c2877cc73d001b7cd0b18e24a700a070   5 minutes ago       Running             dev-container               0                   337ebe54a6223       secret-pod<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl <span class="hljs-built_in">exec</span> pod/secret-pod -- <span class="hljs-built_in">ls</span> /etc/secret<br>password<br>username<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl <span class="hljs-built_in">exec</span> pod/secret-pod -- <span class="hljs-built_in">cat</span> /etc/secret/password<br>KvLftKgs4aV<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl <span class="hljs-built_in">exec</span> pod/secret-pod -- <span class="hljs-built_in">cat</span> /etc/secret/username<br>production-instance<br></code></pre></td></tr></table></figure>

<h1 id="DockerFile和Deployment优化"><a href="#DockerFile和Deployment优化" class="headerlink" title="DockerFile和Deployment优化"></a>DockerFile和Deployment优化</h1><p>参考： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards/#restricted">https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards/#restricted</a></p>
<h2 id="Task-9"><a href="#Task-9" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>1.分析和编辑给定的 Dockerfile &#x2F;cks&#x2F;docker&#x2F;Dockerfile（基于 ubuntu:16.04 镜像），<br>并修复在文件中拥有的突出的安全&#x2F;最佳实践问题的两个指令。</p>
<p>2.分析和编辑给定的清单文件 &#x2F;cks&#x2F;docker&#x2F;deployment.yaml ，<br>并修复在文件中拥有突出的安全&#x2F;最佳实践问题的两个字段。</p>
<p>注意：请勿添加或删除配置设置；只需修改现有的配置设置让以上两个配置设置都不再有安全&#x2F;最佳实践问题。<br>注意：如果您需要非特权用户来执行任何项目，请使用用户 ID 65535 的用户 nobody 。<br>只修改即可，不需要创建</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">## /cks/docker/Dockerfile</span><br><span class="hljs-keyword">FROM</span> ubuntu:latest<br><br><span class="hljs-keyword">USER</span> root<br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt get install -y nginx=4.2</span><br><span class="hljs-keyword">ENV</span> <span class="hljs-keyword">ENV</span>=testing<br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;nginx -d&quot;</span>]</span><br></code></pre></td></tr></table></figure>

<p>两个指令 镜像版本 USER</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">## /cks/docker/Dockerfile</span><br><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">16.04</span><br><br><span class="hljs-keyword">USER</span> <span class="hljs-number">65535</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt get install -y nginx=4.2</span><br><span class="hljs-keyword">ENV</span> <span class="hljs-keyword">ENV</span>=testing<br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;nginx -d&quot;</span>]</span><br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## /cks/docker/deployment.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">lady_killer9_test</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx1</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx2</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.14.2</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">securityContext:</span><br>            &#123;<span class="hljs-string">&#x27;capabilities&#x27;</span><span class="hljs-string">:</span>&#123;<span class="hljs-string">&#x27;add&#x27;</span><span class="hljs-string">:</span>[<span class="hljs-string">&#x27;NET_ADMIN&#x27;</span>],<span class="hljs-string">&#x27;drop&#x27;</span><span class="hljs-string">:</span>[<span class="hljs-string">&#x27;all&#x27;</span>]&#125;,<span class="hljs-attr">&#x27;privileged&#x27;:</span> <span class="hljs-literal">True</span>,<span class="hljs-attr">&#x27;readOnlyRootFilesystem&#x27;:</span> <span class="hljs-literal">False</span>,<span class="hljs-attr">&#x27;runAsUser&#x27;:</span> <span class="hljs-number">65535</span>&#125;<br></code></pre></td></tr></table></figure>

<p>两个错误 </p>
<ol>
<li>privileged应该设置为False保障权限</li>
<li>labels 应统一</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## /cks/docker/deployment.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">lady_killer9_test</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.14.2</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">securityContext:</span><br>            &#123;<span class="hljs-string">&#x27;capabilities&#x27;</span><span class="hljs-string">:</span>&#123;<span class="hljs-string">&#x27;add&#x27;</span><span class="hljs-string">:</span>[<span class="hljs-string">&#x27;NET_ADMIN&#x27;</span>],<span class="hljs-string">&#x27;drop&#x27;</span><span class="hljs-string">:</span>[<span class="hljs-string">&#x27;all&#x27;</span>]&#125;,<span class="hljs-attr">&#x27;privileged&#x27;:</span> <span class="hljs-literal">False</span>,<span class="hljs-attr">&#x27;readOnlyRootFilesystem&#x27;:</span> <span class="hljs-literal">False</span>,<span class="hljs-attr">&#x27;runAsUser&#x27;:</span> <span class="hljs-number">65535</span>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="沙箱运行容器gVisor"><a href="#沙箱运行容器gVisor" class="headerlink" title="沙箱运行容器gVisor"></a>沙箱运行容器gVisor</h1><h2 id="什么是gVisor"><a href="#什么是gVisor" class="headerlink" title="什么是gVisor"></a>什么是gVisor</h2><p>在该集群中我选择使用的CRI容器运行时是CRI-O，CRI-O默认的容器运行时处理程序为crun</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# <span class="hljs-built_in">cat</span> /etc/crio/crio.conf.d/10-crio.conf<br>[crio.image]<br>signature_policy = <span class="hljs-string">&quot;/etc/crio/policy.json&quot;</span><br><br>[crio.runtime]<br>default_runtime = <span class="hljs-string">&quot;crun&quot;</span><br><br>[crio.runtime.runtimes.crun]<br>runtime_path = <span class="hljs-string">&quot;/usr/bin/crio-crun&quot;</span><br>monitor_path = <span class="hljs-string">&quot;/usr/bin/crio-conmon&quot;</span><br>allowed_annotations = [<br>    <span class="hljs-string">&quot;io.containers.trace-syscall&quot;</span>,<br>]<br><br>[crio.runtime.runtimes.runc]<br>runtime_path = <span class="hljs-string">&quot;/usr/bin/crio-runc&quot;</span><br>monitor_path = <span class="hljs-string">&quot;/usr/bin/crio-conmon&quot;</span><br></code></pre></td></tr></table></figure>

<p>而这个gVisor(runsc)是谷歌开发的另一种容器运行时处理程序 他和runc crun kata 属于同一个概念</p>
<blockquote>
<p>gVisor 是 Google 开源的一个用户态容器运行时,它提供了一个额外的软件层来增强容器的隔离和安全性。</p>
<p>尽管这些容器运行时都属于同一个概念范畴,但它们在实现方式和特性上存在一些差异:</p>
<ul>
<li>gVisor 提供了软件级别的沙箱隔离,介于 runc&#x2F;crun 和 Kata Containers 之间。</li>
<li>runc 和 crun 是轻量级的 OCI 容器运行时,主要负责容器的基本生命周期管理。</li>
<li>Kata Containers 则使用了虚拟机技术,提供了更强的隔离性,但开销也更大。</li>
</ul>
</blockquote>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="安装runsc"><a href="#安装runsc" class="headerlink" title="安装runsc"></a>安装runsc</h3><p>Ansible批量操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$</span> <span class="hljs-string">cat</span> <span class="hljs-string">/home/shanwen/WorkSpace/Ansible/yaml/crio.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">k8s</span> <br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apt:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">runsc</span><br>      <span class="hljs-attr">state:</span> <span class="hljs-string">latest</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">copy:</span><br>      <span class="hljs-attr">src:</span> <span class="hljs-string">/home/shanwen/WorkSpace/Ansible/conf/10-crio.conf</span><br>      <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/crio/crio.conf.d/10-crio.conf</span><br>      <span class="hljs-attr">owner:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">systemd:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">crio</span><br>      <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">systemd:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">kubelet</span><br>      <span class="hljs-attr">daemon_reload:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br></code></pre></td></tr></table></figure>

<p>cri-o配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ <span class="hljs-built_in">cat</span> ~/WorkSpace/Ansible/conf/10-crio.conf<br>[crio.image]<br>signature_policy = <span class="hljs-string">&quot;/etc/crio/policy.json&quot;</span><br><br>[crio.runtime]<br>default_runtime = <span class="hljs-string">&quot;crun&quot;</span><br><br>[crio.runtime.runtimes.crun]<br>runtime_path = <span class="hljs-string">&quot;/usr/bin/crio-crun&quot;</span><br>monitor_path = <span class="hljs-string">&quot;/usr/bin/crio-conmon&quot;</span><br>allowed_annotations = [<br>    <span class="hljs-string">&quot;io.containers.trace-syscall&quot;</span>,<br>]<br><br>[crio.runtime.runtimes.runc]<br>runtime_path = <span class="hljs-string">&quot;/usr/bin/crio-runc&quot;</span><br>monitor_path = <span class="hljs-string">&quot;/usr/bin/crio-conmon&quot;</span><br><br>[crio.runtime.runtimes.runsc]<br>runtime_path = <span class="hljs-string">&quot;/usr/bin/runsc&quot;</span><br>monitor_path = <span class="hljs-string">&quot;/usr/bin/crio-conmon&quot;</span>     <span class="hljs-comment"># monitor 在容器运行时系统中的主要作用就是监视容器的运行状况,并将相关信息上报给 CRI-O。</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ ansible k8s -m shell -a <span class="hljs-string">&quot;crictl info | grep runsc&quot;</span><br>192.168.10.52 | CHANGED | rc=0 &gt;&gt;<br>      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;runsc&quot;</span>,<br>192.168.10.50 | CHANGED | rc=0 &gt;&gt;<br>      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;runsc&quot;</span>,<br>192.168.10.51 | CHANGED | rc=0 &gt;&gt;<br>      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;runsc&quot;</span>,<br></code></pre></td></tr></table></figure>



<h2 id="Context-1"><a href="#Context-1" class="headerlink" title="Context"></a>Context</h2><p>该 cluster 使用 <strong>containerd</strong> 作为 CRI 运行时。<strong>containerd</strong> 的默认运行时处理程序是 <strong>runc</strong> 。<br><strong>containerd</strong> 已准备好支持额外的运行时处理程序 <strong>runsc</strong> (gVisor)。</p>
<h2 id="Task-10"><a href="#Task-10" class="headerlink" title="Task"></a>Task</h2><p>使用名为 <strong>runsc</strong> 的现有运行时处理程序，创建一个名为 <strong>untrusted</strong> 的 RuntimeClass。<br>更新 namespace <strong>server</strong> 中的所有 Pod 以在 <strong>gVisor</strong> 上运行。<br>您可以在 <strong>&#x2F;cks&#x2F;gVisor&#x2F;rc.yaml</strong> 中找到一个模版清单。</p>
<h3 id="创建RUNTIME资源"><a href="#创建RUNTIME资源" class="headerlink" title="创建RUNTIME资源"></a>创建RUNTIME资源</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">node.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RuntimeClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">untrusted</span><br><span class="hljs-attr">handler:</span> <span class="hljs-string">runsc</span>                           <span class="hljs-comment">##这个字段就是CRI-O配置中的 [crio.runtime.runtimes.runsc]</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl  apply -f task11Runtime.yaml<br>runtimeclass.node.k8s.io/untrusted created<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get runtimeclasses.node.k8s.io <br>NAME        HANDLER   AGE<br>untrusted   runsc     4s<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl describe runtimeclasses.node.k8s.io <br>Name:         untrusted<br>Namespace:    <br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>API Version:  node.k8s.io/v1<br>Handler:      runsc<br>Kind:         RuntimeClass<br>Metadata:<br>  Creation Timestamp:  2024-05-31T15:51:06Z<br>  Resource Version:    323130<br>  UID:                 014cd520-5c6b-4abe-9173-8432a46237c6<br>Events:                &lt;none&gt;<br></code></pre></td></tr></table></figure>

<h3 id="使用runsc"><a href="#使用runsc" class="headerlink" title="使用runsc"></a>使用runsc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl config set-context --current --namespace server<br>Context <span class="hljs-string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl config get-contexts <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   server<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get po,deployments.apps <br>NAME                               READY   STATUS    RESTARTS   AGE<br>pod/busybox-run-85d9b9fc5d-vqr7q   1/1     Running   0          93s<br>pod/nginx-host-5477c4966f-m24ft    1/1     Running   0          80s<br>pod/run-test-58fc6dcfcb-r8b6w      1/1     Running   0          51s<br><br>NAME                          READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/busybox-run   1/1     1            1           2m43s<br>deployment.apps/nginx-host    1/1     1            1           2m24s<br>deployment.apps/run-test      1/1     1            1           2m17s<br></code></pre></td></tr></table></figure>

<p>可以看出来它们都来自deployment 直接更改deploymen</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl edit deployments.apps busybox-run<br></code></pre></td></tr></table></figure>

<p>记得是template下的spec 不是deployment下的spec</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">..............</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">busybox-run</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">terminationMessagePath:</span> <span class="hljs-string">/dev/termination-log</span><br>        <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">File</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>      <span class="hljs-attr">runtimeClassName:</span> <span class="hljs-string">runsc</span><br><span class="hljs-string">..................</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get deployments.apps -o yaml | grep runtime<br>        runtimeClassName: runc<br>        runtimeClassName: runc<br>        runtimeClassName: runc<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get deployments.apps <br>NAME          READY   UP-TO-DATE   AVAILABLE   AGE<br>busybox-run   1/1     1            1           13h<br>nginx-host    1/1     1            1           13h<br>run-test      1/1     1            1           13h<br></code></pre></td></tr></table></figure>

<p>为什么是runc?</p>
<p><a target="_blank" rel="noopener" href="https://gvisor.dev/docs/user_guide/quick_start/kubernetes/">https://gvisor.dev/docs/user_guide/quick_start/kubernetes/</a></p>
<p>因为cri-o暂不支持使用gvisor(runsc)到kubernetes中 我使用runc代替了runsc 效果出来即可</p>
<p>cri-o配置文件中 已经有runc的handler 直接去k8s中定义runtime类即可 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">node.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RuntimeClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">untrusted</span><br><span class="hljs-attr">handler:</span> <span class="hljs-string">runsc</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">node.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RuntimeClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">runc</span><br><span class="hljs-attr">handler:</span> <span class="hljs-string">runc</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get runtimeclasses.node.k8s.io <br>NAME        HANDLER   AGE<br>runc        runc      143m<br>untrusted   runsc     14h<br></code></pre></td></tr></table></figure>



<h1 id="网络策略-NetworkPolicy"><a href="#网络策略-NetworkPolicy" class="headerlink" title="网络策略 NetworkPolicy"></a>网络策略 NetworkPolicy</h1><p>参考： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/#the-two-sorts-of-pod-isolation">https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/#the-two-sorts-of-pod-isolation</a></p>
<h2 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h2><blockquote>
<p>创建一个名为 <strong>pod-restriction</strong> 的 NetworkPolicy 来限制对在 namespace <strong>dev-team</strong> 中运行的 Pod <strong>products-service</strong> 的访问。<br>只允许以下 Pod 连接到 Pod <strong>products-service</strong></p>
<ul>
<li>namespace <strong>qaqa</strong> 中的 Pod</li>
<li>位于任何 namespace，带有标签 <strong>environment: testing</strong> 的 Pod<br>注意：确保应用 NetworkPolicy。</li>
</ul>
<p>你可以在 <strong>&#x2F;cks&#x2F;net&#x2F;po.yaml</strong> 找到一个模板清单文件。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get pod -o wide <br>NAME               READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES<br>products-service   1/1     Running   0          86s   10.244.69.241   knode2   &lt;none&gt;           &lt;none&gt;<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ ssh root@Kmaster <span class="hljs-string">&quot;curl 10.244.69.241&quot;</span><br>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br>                                 Dload  Upload   Total   Spent    Left  Speed<br>100   615  100   615    0     0   489k      0 --:--:-- --:--:-- --:--:--  600k<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;<br>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br>&lt;style&gt;<br>html &#123; color-scheme: light dark; &#125;<br>body &#123; width: 35em; margin: 0 auto;<br>font-family: Tahoma, Verdana, Arial, sans-serif; &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get pod --show-labels <br>NAME               READY   STATUS    RESTARTS   AGE   LABELS<br>products-service   1/1     Running   0          30m   lable=products-service,run=products-service<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl label ns qaqa ns=qaqa<br>namespace/qaqa labeled<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get ns --show-labels | grep qaqa<br>qaqa               Active   56s     kubernetes.io/metadata.name=qaqa,ns=qaqa<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-restriction</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev-team</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">lable:</span> <span class="hljs-string">products-service</span><br>  <span class="hljs-attr">policyTypes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-attr">ingress:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>                             <span class="hljs-comment">## 允许NS标签为 ns=qaqa的任何pod</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span><br>            <span class="hljs-attr">matchLabels:</span><br>              <span class="hljs-attr">ns:</span> <span class="hljs-string">qaqa</span><br>          <span class="hljs-attr">podSelector:</span> &#123;&#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>								<span class="hljs-comment">## 允许所有NS中 pod标签为environment=testing</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span> &#123;&#125;<br>          <span class="hljs-attr">podSelector:</span><br>            <span class="hljs-attr">matchLabels:</span><br>              <span class="hljs-attr">environment:</span> <span class="hljs-string">testing</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl describe networkpolicies.networking.k8s.io pod-restriction <br>Name:         pod-restriction<br>Namespace:    dev-team<br>Created on:   2024-06-01 16:40:15 +0800 CST<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>Spec:<br>  PodSelector:     lable=products-service<br>  Allowing ingress traffic:<br>    To Port: &lt;any&gt; (traffic allowed to all ports)<br>    From:<br>      NamespaceSelector: ns=qaqa<br>      PodSelector: &lt;none&gt;<br>    ----------<br>    To Port: &lt;any&gt; (traffic allowed to all ports)<br>    From:<br>      NamespaceSelector: &lt;none&gt;<br>      PodSelector: environment=testing<br>  Not affecting egress traffic<br>  Policy Types: Ingress<br><br></code></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 此时主机访问已经被策略拦截</span><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ ssh root@Kmaster <span class="hljs-string">&quot;curl 10.244.69.241&quot;</span><br>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br>                                 Dload  Upload   Total   Spent    Left  Speed<br>  0     0    0     0    0     0      0      0 --:--:--  0:00:12 --:--:--     0^C<br><br><span class="hljs-comment">## NS为qaqa的任何pod可以访问目标pod</span><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get pod -n qaqa <br>NAME     READY   STATUS    RESTARTS   AGE<br>testqa   1/1     Running   0          5m55s<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl <span class="hljs-built_in">exec</span> -n qaqa pod/testqa -- wget 10.244.69.241<br>Connecting to 10.244.69.241 (10.244.69.241:80)<br>saving to <span class="hljs-string">&#x27;index.html&#x27;</span><br>index.html           100% |********************************|   615  0:00:00 ETA<br><span class="hljs-string">&#x27;index.html&#x27;</span> saved<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl <span class="hljs-built_in">exec</span> -n qaqa pod/testqa -- <span class="hljs-built_in">cat</span> index.html<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;<br>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br>&lt;style&gt;<br>html &#123; color-scheme: light dark; &#125;<br>body &#123; width: 35em; margin: 0 auto;<br>font-family: Tahoma, Verdana, Arial, sans-serif; &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">## 其他NS下不带environment=testing无法访问</span><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl -n db get pod --show-labels <br>NAME      READY   STATUS    RESTARTS         AGE    LABELS<br>web-pod   1/1     Running   14 (7m32s ago)   2d1h   run=os1<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl -n db <span class="hljs-built_in">exec</span> pod/web-pod -- wget 10.244.69.241<br>Connecting to 10.244.69.241 (10.244.69.241:80)<br>^C<br><br><span class="hljs-comment">## 打上environment=testing的pod可以访问</span><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl -n db label pod/web-pod environment=testing<br>pod/web-pod labeled<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl -n db get pod --show-labels <br>NAME      READY   STATUS    RESTARTS         AGE    LABELS<br>web-pod   1/1     Running   14 (8m51s ago)   2d1h   environment=testing,run=os1<br><br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl -n db <span class="hljs-built_in">exec</span> pod/web-pod -- wget 10.244.69.241<br>Connecting to 10.244.69.241 (10.244.69.241:80)<br>saving to <span class="hljs-string">&#x27;index.html&#x27;</span><br>index.html           100% |********************************|   615  0:00:00 ETA<br><span class="hljs-string">&#x27;index.html&#x27;</span> saved<br></code></pre></td></tr></table></figure>



<h1 id="Container安全上下文"><a href="#Container安全上下文" class="headerlink" title="Container安全上下文"></a>Container安全上下文</h1><p>参考： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/security-context/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/security-context/</a></p>
<h2 id="Task-11"><a href="#Task-11" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>按照如下要求修改 <strong>sec-ns</strong> 命名空间里的 Deployment <strong>secdep</strong></p>
<ul>
<li>用ID为 <strong>30000</strong> 的用户启动容器（设置用户ID为: 30000）</li>
<li>不允许进程获得超出其父进程的特权（禁止allowPrivilegeEscalation）</li>
<li>以只读方式加载容器的根文件系统（对根文件的只读权限）</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl config get-contexts <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   sec-ns<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get deployments.apps <br>NAME     READY   UP-TO-DATE   AVAILABLE   AGE<br>secdep   1/1     1            1           2m21s<br>shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl edit deployments.apps<br></code></pre></td></tr></table></figure>

<p>看示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">security-context-demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">securityContext:</span><br>    <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sec-ctx-vol</span><br>    <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sec-ctx-demo</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28</span><br>    <span class="hljs-attr">command:</span> [ <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;sleep 1h&quot;</span> ]<br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sec-ctx-vol</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/demo</span><br>    <span class="hljs-attr">securityContext:</span><br>      <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ol>
<li>runAsUser 更改应该在Pod（Deppoyment）的spec下</li>
<li>另外两个属于Container权限 在Container字段下修改</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...................</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">secdep</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">tail</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/dev/null</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">alpine</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">alpine</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">terminationMessagePath:</span> <span class="hljs-string">/dev/termination-log</span><br>        <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">File</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>      <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">default-scheduler</span><br>      <span class="hljs-attr">securityContext:</span><br>        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">3000</span><br><span class="hljs-string">..................</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:/home/shanwen/WorkSpace/K8s/cks$ kubectl get deployments.apps,pod<br>NAME                     READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/secdep   1/1     1            1           21m<br><br>NAME                          READY   STATUS    RESTARTS   AGE<br>pod/secdep-67464f4c88-gpvrm   1/1     Running   0          2m44s<br></code></pre></td></tr></table></figure>



<h1 id="启用API-server认证"><a href="#启用API-server认证" class="headerlink" title="启用API server认证"></a>启用API server认证</h1><p>参考: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/">https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/</a></p>
<h2 id="环境布置"><a href="#环境布置" class="headerlink" title="环境布置"></a>环境布置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.50</span><span class="hljs-string">:6443</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">component:</span> <span class="hljs-string">kube-apiserver</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">control-plane</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-apiserver</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kube-apiserver</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--advertise-address=192.168.10.50</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--allow-privileged=true</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--authorization-mode=AlwaysAllow</span><br>    <span class="hljs-comment">#- --authorization-mode=Node,RBAC</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--enable-admission-plugins=AlwaysAdmit</span><br>    <span class="hljs-comment">#- --enable-admission-plugins=NodeRestriction</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--enable-bootstrap-token-auth=true</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="hljs-string">........</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# systemctl daemon-reload ; systemctl restart kubelet.service<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:~$ kubectl create clusterrolebinding cluster-admin:anonymous --clusterrole cluster-admin --user anonymous<br>clusterrolebinding.rbac.authorization.k8s.io/cluster-admin:anonymous created<br>shanwen@Arch:~$ kubectl describe clusterrolebindings.rbac.authorization.k8s.io cluster-admin:anonymous <br>Name:         cluster-admin:anonymous<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br>Role:<br>  Kind:  ClusterRole<br>  Name:  cluster-admin<br>Subjects:<br>  Kind  Name       Namespace<br>  ----  ----       ---------<br>  User  anonymous  <br></code></pre></td></tr></table></figure>

<h2 id="Context-2"><a href="#Context-2" class="headerlink" title="Context"></a>Context</h2><blockquote>
<p>由 <strong>kubeadm</strong> 创建的 cluster 的 Kubernetes API 服务器，出于测试目的，<br>临时配置允许未经身份验证和未经授权的访问，授予匿名用户 cluster-admin 的访问权限.</p>
</blockquote>
<h2 id="Task-12"><a href="#Task-12" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>重新配置 cluster 的 Kubernetes APl 服务器，以确保只允许经过身份验证和授权的 REST 请求。<br>使用授权模式 <strong>Node</strong> , <strong>RBAC</strong> 和准入控制器 <strong>NodeRestriction</strong> 。<br>删除用户 <strong>system:anonymous</strong> 的 ClusterRoleBinding 来进行清理。</p>
<p>注意：所有 kubectl 配置环境&#x2F;文件也被配置使用未经身份验证和未经授权的访问。<br>你不必更改它，但请注意，一旦完成 cluster 的安全加固， kubectl 的配置将无法工作。<br>您可以使用位于 cluster 的 master 节点上，cluster 原本的 kubectl 配置文件<br><strong>&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</strong> ，以确保经过身份验证的授权的请求仍然被允许。</p>
</blockquote>
<h3 id="修改apiserver配置文件"><a href="#修改apiserver配置文件" class="headerlink" title="修改apiserver配置文件"></a>修改apiserver配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:~$ ssh root@Kmaster <br>root@Kmaster:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.50</span><span class="hljs-string">:6443</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">component:</span> <span class="hljs-string">kube-apiserver</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">control-plane</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-apiserver</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kube-apiserver</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--advertise-address=192.168.10.50</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--allow-privileged=true</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--authorization-mode=Node,RBAC</span>                            <span class="hljs-comment">## modify</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--enable-admission-plugins=NodeRestriction</span>                <span class="hljs-comment">## modify</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--enable-bootstrap-token-auth=true</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--etcd-servers=https://127.0.0.1:2379</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br></code></pre></td></tr></table></figure>

<h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# systemctl daemon-reload ; systemctl restart kubelet.service<br>root@Kmaster:~# kubectl get pod --kubeconfig /etc/kubernetes/admin.conf <br>NAME         READY   STATUS    RESTARTS   AGE<br>testkamino   1/1     Running   2          24h<br><br></code></pre></td></tr></table></figure>

<h3 id="删除ClusterRoleBuding"><a href="#删除ClusterRoleBuding" class="headerlink" title="删除ClusterRoleBuding"></a>删除ClusterRoleBuding</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl --kubeconfig /etc/kubernetes/admin.conf get clusterrolebindings.rbac.authorization.k8s.io cluster-admin:anonymous <br>NAME                      ROLE                        AGE<br>cluster-admin:anonymous   ClusterRole/cluster-admin   7m11s<br>root@Kmaster:~# kubectl --kubeconfig /etc/kubernetes/admin.conf delete clusterrolebindings.rbac.authorization.k8s.io cluster-admin:anonymous <br>clusterrolebinding.rbac.authorization.k8s.io <span class="hljs-string">&quot;cluster-admin:anonymous&quot;</span> deleted<br>root@Kmaster:~# kubectl --kubeconfig /etc/kubernetes/admin.conf get clusterrolebindings.rbac.authorization.k8s.io cluster-admin:anonymous <br>Error from server (NotFound): clusterrolebindings.rbac.authorization.k8s.io <span class="hljs-string">&quot;cluster-admin:anonymous&quot;</span> not found<br></code></pre></td></tr></table></figure>

<h1 id="TLS安全配置"><a href="#TLS安全配置" class="headerlink" title="TLS安全配置"></a>TLS安全配置</h1><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/">https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/</a></p>
<p><a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.6/op-guide/configuration/#security">https://etcd.io/docs/v3.6/op-guide/configuration/#security</a></p>
<h2 id="Task-13"><a href="#Task-13" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>通过TLS加强kube-apiserver安全配置，要求</p>
<ul>
<li>kube-apiserver除了 <strong>TLS 1.3</strong> 及以上的版本可以使用，其他版本都不允许使用。</li>
<li>密码套件（Cipher suite）为 <strong>TLS_AES_128_GCM_SHA256</strong></li>
</ul>
<p>通过TLS加强ETCD安全配置，要求</p>
<ul>
<li>密码套件（Cipher suite）为 <strong>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</strong></li>
</ul>
</blockquote>
<h2 id="Kube-apiserver"><a href="#Kube-apiserver" class="headerlink" title="Kube-apiserver"></a>Kube-apiserver</h2><p>ssh到对应的Master节点上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanwen@Arch:~$ ssh root@Kmaster.<br>root@Kmaster:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">......</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--requestheader-allowed-names=front-proxy-client</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--requestheader-group-headers=X-Remote-Group</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--requestheader-username-headers=X-Remote-User</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--secure-port=6443</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--service-account-issuer=https://kubernetes.default.svc.cluster.local</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--service-account-signing-key-file=/etc/kubernetes/pki/sa.key</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--service-cluster-ip-range=10.96.0.0/12</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--tls-min-version=VersionTLS13</span>                     <span class="hljs-comment">#add</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--tls-cipher-suites=TLS_AES_128_GCM_SHA256</span>         <span class="hljs-comment">#add</span><br><span class="hljs-string">......</span><br></code></pre></td></tr></table></figure>

<p>这两条都可以在kubernetes的文档中找到</p>
<p>修改完成记得重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# systemctl daemon-reload ; systemctl restart kubelet.service<br>shanwen@Arch:~$ kubectl -n kube-system describe pod/kube-apiserver-kmaster | grep tls<br>      --tls-cert-file=/etc/kubernetes/pki/apiserver.crt<br>      --tls-private-key-file=/etc/kubernetes/pki/apiserver.key<br>      --tls-min-version=VersionTLS13<br>      --tls-cipher-suites=TLS_AES_128_GCM_SHA256<br></code></pre></td></tr></table></figure>

<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>在etcd官网找Configuration  options的Security 搜索 cipher</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# vim /etc/kubernetes/manifests/etcd.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">......</span>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--listen-metrics-urls=http://127.0.0.1:2381</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--listen-peer-urls=https://192.168.10.50:2380</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--name=kmaster</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--peer-client-cert-auth=true</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--snapshot-count=10000</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span>			<span class="hljs-comment">#add</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/etcd:3.5.12-0</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br><span class="hljs-string">......</span>   <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# systemctl daemon-reload ; systemctl restart kubelet.service<br></code></pre></td></tr></table></figure>

<p>等待3分钟左右</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~# kubectl get pod -n kube-system <br>NAME                              READY   STATUS    RESTARTS         AGE<br>coredns-7db6d8ff4d-2488w          1/1     Running   26               19d<br>coredns-7db6d8ff4d-knl4n          1/1     Running   26               19d<br>etcd-kmaster                      1/1     Running   0                2m26s<br>kube-apiserver-kmaster            1/1     Running   0                24m<br>kube-controller-manager-kmaster   1/1     Running   40 (6m50s ago)   19d<br>kube-proxy-fxb2p                  1/1     Running   23               18d<br>kube-proxy-g8vr9                  1/1     Running   23               18d<br>kube-proxy-xtrcm                  1/1     Running   23               18d<br>kube-scheduler-kmaster            1/1     Running   39 (6m44s ago)   19d<br>metrics-server-5b68c8cbcc-dc5cs   1/1     Running   23               18d<br>metrics-server-5b68c8cbcc-ts7fl   1/1     Running   23               18d<br>root@Kmaster:~# kubectl describe pod -n kube-system etcd-kmaster | grep cipher <br>      --cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256<br></code></pre></td></tr></table></figure>



<h1 id="ImagePolicyWebhook容器镜像扫描"><a href="#ImagePolicyWebhook容器镜像扫描" class="headerlink" title="ImagePolicyWebhook容器镜像扫描"></a>ImagePolicyWebhook容器镜像扫描</h1><h2 id="这是什么"><a href="#这是什么" class="headerlink" title="这是什么"></a>这是什么</h2><blockquote>
<p>ImagePolicyWebhook 是 Kubernetes 中用于镜像安全控制的一种准入控制器(Admission Controller)。它允许您在 Kubernetes 集群中部署应用程序时,对镜像进行动态的安全审核和验证。</p>
<p>ImagePolicyWebhook 的工作原理如下:</p>
<p><code>流程就是kubelet请求到apiserver再被admission拦截 进行检测后 再由admission发送给apiserver</code></p>
<ol>
<li><strong>kubelet 发起请求</strong><ul>
<li>当 kubelet 需要执行某些操作(如创建 Pod)时,它会向 kube-apiserver 发起 API 请求。</li>
</ul>
</li>
<li><strong>请求到达 kube-apiserver</strong><ul>
<li>kube-apiserver 作为 Kubernetes API 的入口点,首先接收来自 kubelet 的请求。</li>
</ul>
</li>
<li><strong>AdmissionController 拦截</strong><ul>
<li>kube-apiserver 在处理请求之前,会先触发 AdmissionController 插件链。</li>
<li>AdmissionController 会对请求进行各种校验和修改,确保请求符合集群的安全和合规性要求。</li>
</ul>
</li>
<li><strong>AdmissionController 检测和处理</strong><ul>
<li>AdmissionController 会根据预先配置的规则,对 kubelet 发起的请求进行检查和处理。</li>
<li>例如,它可能会验证 kubelet 的身份认证信息,或者修改 Pod 规约中的镜像信息。</li>
</ul>
</li>
<li><strong>请求发送回 kube-apiserver</strong><ul>
<li>如果请求通过了 AdmissionController 的检查,AdmissionController 会将处理后的请求再次发送给 kube-apiserver。</li>
</ul>
</li>
<li><strong>kube-apiserver 处理请求</strong><ul>
<li>kube-apiserver 收到经过 AdmissionController 处理的请求后,会执行实际的资源创建或更新操作。</li>
<li>例如,对于创建 Pod 的请求,kube-apiserver 会将 Pod 信息下发给对应的 kubelet 节点。</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>参考：<a target="_blank" rel="noopener" href="https://github.com/flavio/kube-image-bouncer">https://github.com/flavio/kube-image-bouncer</a></p>
<blockquote>
<p>此准入控制器将拒绝所有使用带有 <code>latest</code> 标签的映像的pod。</p>
</blockquote>
<h4 id="Imagewebhook后端"><a href="#Imagewebhook后端" class="headerlink" title="Imagewebhook后端"></a>Imagewebhook后端</h4><p>使用集群外部的Docker搭建</p>
<p>ca.crt ca.key从Kmaster &#x2F;etc&#x2F;kubernetes&#x2F;pki复制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost pki]# openssl genrsa -out admission.key 2048<br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>........+++++<br>............................+++++<br>e is 65537 (0x010001)<br>[root@localhost pki]# openssl req -new -key admission.key -subj <span class="hljs-string">&quot;/CN=admission&quot;</span> -out admission.csr<br>[root@localhost pki]# openssl x509 -req -<span class="hljs-keyword">in</span> admission.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out admission.crt -da<br>-dates  -days   <br>[root@localhost pki]# openssl x509 -req -<span class="hljs-keyword">in</span> admission.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out admission.crt -da<br>[root@localhost pki]# <span class="hljs-built_in">ls</span><br>admission.crt  admission.csr  admission.key  ca.crt  ca.key  ca.srl<br>[root@localhost pki]# <span class="hljs-built_in">pwd</span><br>/root/admission/pki<br></code></pre></td></tr></table></figure>



<h4 id="Imagewebhook配置文件"><a href="#Imagewebhook配置文件" class="headerlink" title="Imagewebhook配置文件"></a>Imagewebhook配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:/etc/kubernetes# <span class="hljs-built_in">ls</span><br>admin.conf  controller-manager.conf  kubelet.conf  manifests  pki  scheduler.conf  super-admin.conf<br>root@Kmaster:/etc/kubernetes# <span class="hljs-built_in">mkdir</span> admission<br>root@Kmaster:/etc/kubernetes# <span class="hljs-built_in">cd</span> admission/ <br>root@Kmaster:/etc/kubernetes/admission# vim admissionConfig.json<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">/*  /etc/kubernetes/admission/admissionConfig.json  */</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;imagePolicy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;kubeConfigFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/etc/kubernetes/admission/kube-image-bouncer.yml&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;allowTTL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;denyTTL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;retryBackoff&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;defaultAllow&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:/etc/kubernetes/admission# vim /etc/kubernetes/admission/kube-image-bouncer.yml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># /etc/kubernetes/admission/kube-image-bouncer.yml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span><br><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">certificate-authority:</span> <span class="hljs-string">/etc/kubernetes/admission/pki/webhook.pem</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://bouncer.default.svc:1323/image_policy</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">bouncer_webhook</span><br><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">bouncer_webhook</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">api-server</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">bouncer_validator</span><br><span class="hljs-attr">current-context:</span> <span class="hljs-string">bouncer_validator</span><br><span class="hljs-attr">preferences:</span> &#123;&#125;<br><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">api-server</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">client-certificate:</span> <span class="hljs-string">/etc/kubernetes/admission/pki/apiserver-kubelet-client.crt</span><br>    <span class="hljs-attr">client-key:</span>  <span class="hljs-string">/etc/kubernetes/admission/pki/apiserver-kubelet-client.key</span><br></code></pre></td></tr></table></figure>

<h4 id="修改kube-apiserve"><a href="#修改kube-apiserve" class="headerlink" title="修改kube-apiserve"></a>修改kube-apiserve</h4><h2 id="Context-3"><a href="#Context-3" class="headerlink" title="Context"></a>Context</h2><blockquote>
<p>cluster 上设置了容器镜像扫描器，但尚未完全集成到 cluster 的配置中。<br>完成后，容器镜像扫描器应扫描并拒绝易受攻击的镜像的使用。</p>
</blockquote>
<h2 id="Task-14"><a href="#Task-14" class="headerlink" title="Task"></a>Task</h2><blockquote>
<p>注意：你必须在 cluster 的 <strong>master</strong> 节点上完成整个考题，所有服务和文件都已被准备好并放置在该节点上。</p>
<p>给定一个目录 <strong>&#x2F;etc&#x2F;kubernetes&#x2F;epconfig</strong> 中不完整的配置，<br>以及具有 HTTPS 端点 <strong><a target="_blank" rel="noopener" href="https://image-bouncer-webhook.default.svc:1323/image_policy">https://image-bouncer-webhook.default.svc:1323/image_policy</a></strong> 的功能性容器镜像扫描器：</p>
<ul>
<li>启用必要的插件来创建镜像策略</li>
<li>校验控制配置并将其更改为隐式拒绝（implicit deny）</li>
<li>编辑配置以正确指向提供的 HTTPS 端点</li>
</ul>
<p>最后，通过尝试部署易受攻击的资源 <strong>&#x2F;cks&#x2F;img&#x2F;web1.yaml</strong> 来测试配置是否有效。</p>
</blockquote>
<h1 id="添加kubelet用户"><a href="#添加kubelet用户" class="headerlink" title="添加kubelet用户"></a>添加kubelet用户</h1><p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user</a></p>
<p>现客户端kubeadmin权限过大 希望针对一个shanwen NS 创建一个用户 shanwen 他拥有一下权限</p>
<ol>
<li>pod的 get,list,watch,create</li>
</ol>
<h2 id="创建Key和CRT"><a href="#创建Key和CRT" class="headerlink" title="创建Key和CRT"></a>创建Key和CRT</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kubeletUser# openssl genrsa -out shanwen.key 2048<br>root@Kmaster:~/kubeletUser# openssl req -new -key shanwen.key -out shanwen.csr -subj <span class="hljs-string">&quot;/CN=shanwen&quot;</span> <br>root@Kmaster:~/kubeletUser# <span class="hljs-built_in">ls</span><br>shanwen.csr  shanwen.key<br></code></pre></td></tr></table></figure>

<h2 id="创建K8s的CRT"><a href="#创建K8s的CRT" class="headerlink" title="创建K8s的CRT"></a>创建K8s的CRT</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 获取Request字段内容</span><br>root@Kmaster:~/kubeletUser# <span class="hljs-built_in">cat</span> shanwen.csr | <span class="hljs-built_in">base64</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&quot;\n&quot;</span> ;<span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n&quot;</span><br>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1Z6Q0NBVDhDQVFBd0VqRVFNQTRHQTFVRUF3d0hjMmhoYm5kbGJqQ0NBU0l3RFFZSktvWklodmNOQVFFQgpCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFKVDFPY2VRN2txQ3ExYjdma0tuNDRjdUpoUXRnYlJKdVphbldKOGF3YkRBCk1VZ2lQN1JmOGFBVzBaekU1aUdhTjd5dEMyd2h1WGMycVlhKzlVd29PM2JOM2tCU0pGT2VCUVlKMzgxM3p6UGMKQ3dOK0Y3RnNZOXVzaXVlbXF4SjVYMkZPQXVCc21EZWlRWGJBblVvcE9FbTE3QmovVWxrRmxRUEhpRUVmOUllaQp5OE9NM3FCelFRZmdJZjZjS1hIcVdrYWw0ZW9Ba25wQ3ZoR21RbFlnZEpReDltL0Z3eFdSeGpHWTJFVDVHeXoyCkRHYkV0VzNxMW5QWVB3dDg0Q01ZM1FnUnd6MUZGNjJQbFZ5TkpsbzdVRXZtY3hpMVRiRzBLVG9mb0h2S3M0c2IKNkhHUTY3RFlnMHRTSEdIbWtRUGNZaTRHVFZ2aGY0RERja0RlQk93Z1lza0NBd0VBQWFBQU1BMEdDU3FHU0liMwpEUUVCQ3dVQUE0SUJBUUE5SlVRSWowZWVrdjRwd0ExdElUMnovdkhYT282Ym9MQ0JVQ0lZRUZLSlpJZHF1YldHCk9wbUNKemkwcVZNSVlSWFdWWnJrK3NFZlMya0ZLNVlGR3V1R0NSMWRtWWlXMmFOazNSMThWRFhrQVRuaTlHVWcKanVBZXBaVGJtbXVTMUhiTkVCSlhUZ3E4MnZCTTVaNGpvcGVrNTNnWU1lZ3JjQUdVbW0yUm81Z0pmTzRhWHZjbwpjS1Nvcjl4RmVPZTN0VGVKQmZOaFAySDZUTFJhWDlSRkN5M1lETHNjdFBWcGc4ckhLVEZoTTlIRlJ1R2lmenoyCkFkekJrdHJHeVpPRVIySXNqNWpLV3RBNVhGcGZpSnR1cTd2NzJvVERDZXhTclFzNUlHbmVCQ2NacERuNzVTaTQKUUtZWXc5UlVZNzlHbjAxci90cEFKTmd3OGVYbVhsbmFxeVhWCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">certificates.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CertificateSigningRequest</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">shanwen</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">request:</span> <span class="hljs-string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1Z6Q0NBVDhDQVFBd0VqRVFNQTRHQTFVRUF3d0hjMmhoYm5kbGJqQ0NBU0l3RFFZSktvWklodmNOQVFFQgpCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFKVDFPY2VRN2txQ3ExYjdma0tuNDRjdUpoUXRnYlJKdVphbldKOGF3YkRBCk1VZ2lQN1JmOGFBVzBaekU1aUdhTjd5dEMyd2h1WGMycVlhKzlVd29PM2JOM2tCU0pGT2VCUVlKMzgxM3p6UGMKQ3dOK0Y3RnNZOXVzaXVlbXF4SjVYMkZPQXVCc21EZWlRWGJBblVvcE9FbTE3QmovVWxrRmxRUEhpRUVmOUllaQp5OE9NM3FCelFRZmdJZjZjS1hIcVdrYWw0ZW9Ba25wQ3ZoR21RbFlnZEpReDltL0Z3eFdSeGpHWTJFVDVHeXoyCkRHYkV0VzNxMW5QWVB3dDg0Q01ZM1FnUnd6MUZGNjJQbFZ5TkpsbzdVRXZtY3hpMVRiRzBLVG9mb0h2S3M0c2IKNkhHUTY3RFlnMHRTSEdIbWtRUGNZaTRHVFZ2aGY0RERja0RlQk93Z1lza0NBd0VBQWFBQU1BMEdDU3FHU0liMwpEUUVCQ3dVQUE0SUJBUUE5SlVRSWowZWVrdjRwd0ExdElUMnovdkhYT282Ym9MQ0JVQ0lZRUZLSlpJZHF1YldHCk9wbUNKemkwcVZNSVlSWFdWWnJrK3NFZlMya0ZLNVlGR3V1R0NSMWRtWWlXMmFOazNSMThWRFhrQVRuaTlHVWcKanVBZXBaVGJtbXVTMUhiTkVCSlhUZ3E4MnZCTTVaNGpvcGVrNTNnWU1lZ3JjQUdVbW0yUm81Z0pmTzRhWHZjbwpjS1Nvcjl4RmVPZTN0VGVKQmZOaFAySDZUTFJhWDlSRkN5M1lETHNjdFBWcGc4ckhLVEZoTTlIRlJ1R2lmenoyCkFkekJrdHJHeVpPRVIySXNqNWpLV3RBNVhGcGZpSnR1cTd2NzJvVERDZXhTclFzNUlHbmVCQ2NacERuNzVTaTQKUUtZWXc5UlVZNzlHbjAxci90cEFKTmd3OGVYbVhsbmFxeVhWCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><br>  <span class="hljs-attr">signerName:</span> <span class="hljs-string">kubernetes.io/kube-apiserver-client</span><br>  <span class="hljs-attr">usages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">client</span> <span class="hljs-string">auth</span><br></code></pre></td></tr></table></figure>

<h2 id="批准证书创建"><a href="#批准证书创建" class="headerlink" title="批准证书创建"></a>批准证书创建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kubeletUser# kubectl apply -f shanwenCRT.yaml<br>certificatesigningrequest.certificates.k8s.io/shanwen created<br>root@Kmaster:~/kubeletUser# kubectl get certificatesigningrequests.certificates.k8s.io <br>NAME      AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION<br>shanwen   5s    kubernetes.io/kube-apiserver-client   kubernetes-admin   &lt;none&gt;              Pending<br>root@Kmaster:~/kubeletUser# kubectl certificate approve shanwen <br>certificatesigningrequest.certificates.k8s.io/shanwen approved<br>root@Kmaster:~/kubeletUser# kubectl get certificatesigningrequests.certificates.k8s.io <br>NAME      AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION<br>shanwen   22s   kubernetes.io/kube-apiserver-client   kubernetes-admin   &lt;none&gt;              Approved,Issued<br></code></pre></td></tr></table></figure>

<h2 id="获取证书"><a href="#获取证书" class="headerlink" title="获取证书"></a>获取证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kubeletUser# kubectl get certificatesigningrequests.certificates.k8s.io shanwen -o jsonpath=<span class="hljs-string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="hljs-built_in">base64</span> -d &gt; shanwen.crt <br>root@Kmaster:~/kubeletUser# vim shanwen.crt <br>root@Kmaster:~/kubeletUser# kubectl get certificatesigningrequests.certificates.k8s.io shanwen -o jsonpath=<span class="hljs-string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="hljs-built_in">base64</span> -d<br>-----BEGIN CERTIFICATE-----<br>MIIC9zCCAd+gAwIBAgIQNhAu1Vw5dSTwZz0jbg7s2jANBgkqhkiG9w0BAQsFADAV<br>MRMwEQYDVQQDEwprdWJlcm5ldGVzMB4XDTI0MDYxMjA4MzYzNFoXDTI1MDYxMjA4<br>MzYzNFowEjEQMA4GA1UEAxMHc2hhbndlbjCCASIwDQYJKoZIhvcNAQEBBQADggEP<br>ADCCAQoCggEBAJT1OceQ7kqCq1b7fkKn44cuJhQtgbRJuZanWJ8awbDAMUgiP7Rf<br>8aAW0ZzE5iGaN7ytC2whuXc2qYa+9UwoO3bN3kBSJFOeBQYJ3813zzPcCwN+F7Fs<br>Y9usiuemqxJ5X2FOAuBsmDeiQXbAnUopOEm17Bj/UlkFlQPHiEEf9Ieiy8OM3qBz<br>QQfgIf6cKXHqWkal4eoAknpCvhGmQlYgdJQx9m/FwxWRxjGY2ET5Gyz2DGbEtW3q<br>1nPYPwt84CMY3QgRwz1FF62PlVyNJlo7UEvmcxi1TbG0KTofoHvKs4sb6HGQ67DY<br>g0tSHGHmkQPcYi4GTVvhf4DDckDeBOwgYskCAwEAAaNGMEQwEwYDVR0lBAwwCgYI<br>KwYBBQUHAwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBR3RKIFKCqJL8SHBvC0<br>OwUetRxREDANBgkqhkiG9w0BAQsFAAOCAQEAlcFAugpKE2ShUVcVt9TJHqwqlHTf<br>TcEM3VszbiaW1UllA5Qj1L0h5iAoa4eRrHWbFIgfXmml5oQkxDiA6n0qaCldyGeg<br>dr3yx28eBuctq5xbq1yLUz5j7BBc5yzxATz0+7w9IaRdN5oP8L5Dg2hUA13V5LLj<br>02X1aGKoFB8ufhxmBA5uGyql+LAjmx6mEWEZExJU1kAf59q+wlhmEOm8tU++4DUM<br>3zTNzR8lhfEcmK7KG3X5sI56xJUULiLXkBFVIO3szjI4A7d+MBlXI2uuamE2JDrl<br>TgdMs8yHs7DtM16V14Qr5iOqhjpbyNMhjlSF2uGnoR6BgMW+KBZkT0pQcw==<br>-----END CERTIFICATE-----<br>root@Kmaster:~/kubeletUser# <span class="hljs-built_in">ls</span><br>shanwen.crt  shanwen.csr  shanwen.key  shanwenCRT.yaml<br></code></pre></td></tr></table></figure>

<h2 id="集群内创建用户"><a href="#集群内创建用户" class="headerlink" title="集群内创建用户"></a>集群内创建用户</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">shanwen_role</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">shanwen</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">shanwen_ns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">shanwen</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">shanwen</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">shanwen_role</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kubeletUser# kubectl get role,rolebindings.rbac.authorization.k8s.io <br>NAME                                          CREATED AT<br>role.rbac.authorization.k8s.io/shanwen_role   2024-06-12T09:02:09Z<br><br>NAME                                               ROLE                AGE<br>rolebinding.rbac.authorization.k8s.io/shanwen_ns   Role/shanwen_role   23s<br></code></pre></td></tr></table></figure>

<h2 id="添加Kubeconfig"><a href="#添加Kubeconfig" class="headerlink" title="添加Kubeconfig"></a>添加Kubeconfig</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@Kmaster:~/kubeletUser# kubectl config set-credentials shanwen --client-key shanwen.key --client-certificate shanwen.crt --embed-certs=<span class="hljs-literal">true</span><br>User <span class="hljs-string">&quot;shanwen&quot;</span> <span class="hljs-built_in">set</span>.<br>root@Kmaster:~/kubeletUser# kubectl config set-context shanwen --cluster kubernetes --user shanwen <br>Context <span class="hljs-string">&quot;shanwen&quot;</span> created.<br>root@Kmaster:~/kubeletUser# <span class="hljs-built_in">cat</span> /etc/kubernetes/admin.conf | grep shanwen <br>    namespace: shanwen<br>    user: shanwen<br>  name: shanwen<br>- name: shanwen<br></code></pre></td></tr></table></figure>

<h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">oot@Kmaster:~/kubeletUser# kubectl config get-contexts  <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   shanwen<br>          shanwen                       kubernetes   shanwen            <br>root@Kmaster:~/kubeletUser# kubectl config use-context shanwen --namespace shanwen <br>Switched to context <span class="hljs-string">&quot;shanwen&quot;</span>.<br>root@Kmaster:~/kubeletUser# kubectl config get-contexts  <br>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE<br>          kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   shanwen<br>*         shanwen                       kubernetes   shanwen            <br>root@Kmaster:~/kubeletUser# kubectl get pod <br>Error from server (Forbidden): pods is forbidden: User <span class="hljs-string">&quot;shanwen&quot;</span> cannot list resource <span class="hljs-string">&quot;pods&quot;</span> <span class="hljs-keyword">in</span> API group <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">in</span> the namespace <span class="hljs-string">&quot;default&quot;</span><br>root@Kmaster:~/kubeletUser# kubectl get pod -n shanwen <br>No resources found <span class="hljs-keyword">in</span> shanwen namespace.<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ops/" class="print-no-link">#ops</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>K8S</div>
      <div>http://example.com/2025/02/06/K8S/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年2月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/02/06/Contailer/" title="Contailer">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Contailer</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/02/06/English/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
